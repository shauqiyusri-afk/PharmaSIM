<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PharmaSim AI â€” Enhanced Simulation + 3D Molecules</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- ðŸ“¦ CSV parsing -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- ðŸ§ª 3D Viewer (3Dmol.js) -->
<script src="https://3dmol.csb.pitt.edu/build/3Dmol.js"></script>
<style>
  /* ------------------------- BODY & BACKGROUND ------------------------- */
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: start;
    padding-top: 2rem;
    background-color: black;
    overflow-x: hidden;
  }
  .bg-image {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -3;
  }
  .overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.35);
    z-index: -2;
  }

  /* ------------------------- CARD LAYOUT ------------------------- */
  .card {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    width: 100%;
    max-width: 1200px;
    overflow: hidden;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    padding: 2rem;
    animation: fadeIn 0.8s ease-out;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  @keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

  /* ------------------------- FORM ------------------------- */
  form label {
    font-weight: 600;
    margin-bottom: 0.25rem;
    display: block;
    color: white;
  }
  form input, form select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    margin-bottom: 1rem;
    transition: all 0.2s;
  }
  form input:focus, form select:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 2px rgba(79,70,229,0.2);
  }

  /* ------------------------- BUTTONS ------------------------- */
  .btn-main {
    padding: 0.75rem 1.5rem;
    border-radius: 9999px;
    font-weight: bold;
    font-size: 1.1rem;
    margin: 0.25rem 0;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.25s ease;
  }
  .btn-login { background-color:#4f46e5; color:white; }
  .btn-login:hover { background-color:white; color:#4f46e5; border-color:#4f46e5; transform:translateY(-2px) scale(1.05); }
  .btn-register { background-color:#10b981; color:white; }
  .btn-register:hover { background-color:white; color:#10b981; border-color:#10b981; transform:translateY(-2px) scale(1.05); }
  .btn-action { background-color:#f59e0b; color:white; }
  .btn-action:hover { background-color:#b45309; }

  /* ------------------------- OUTPUT PANEL ------------------------- */
  #outputPanel { display:none; margin-top:1rem; color:#1f2937; }

  /* ------------------------- TOP MATCHES ------------------------- */
  #matchesList > div {
    background: rgba(255,255,255,0.75);
    padding: 0.75rem;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.1);
    transition: transform 0.25s, box-shadow 0.25s;
  }
  #matchesList > div:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* ------------------------- TABLE AND CHARTS LAYOUT ------------------------- */
  .table-charts-container {
    display: flex;
    gap: 2rem;
    margin-top: 1.5rem;
    align-items: flex-start;
  }
  .table-section { flex: 1; min-width: 0; }
  .charts-section { flex: 1; display: flex; flex-direction: column; gap: 1.5rem; }

  /* ------------------------- TABLE ------------------------- */
  table { 
    width: 100%; 
    border-collapse: collapse; 
    background: white; 
    border-radius: 12px; 
    overflow: hidden; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
  }
  th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
  th { background: #e0e7ff; font-weight: 600; }
  tbody tr:nth-child(even) { background: #f9fafb; }

  /* ------------------------- RADAR CHART ------------------------- */
  .radar-wrap { 
    position: relative; 
    height: 380px; 
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  .radar-title {
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  /* ------------------------- MATCH IMAGE ------------------------- */
  #matchedImageArea img { border-radius: 50%; width: 120px; height: 120px; object-fit: cover; margin-bottom: 0.5rem; transition: transform 0.3s; }
  #matchedImageArea img:hover { transform: scale(1.1); }
  #matchedImageArea { display: flex; justify-content: center; align-items: center; margin-bottom: 0.5rem; }

  /* ------------------------- 3D VIEWER PANEL ------------------------- */
  .viewer-card {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.25);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  }
  #molViewer { height: 360px; width: 100%; border-radius: 16px; overflow: hidden; }

  /* ------------------------- RESPONSIVE ------------------------- */
  @media(max-width:1024px){ 
    .card { grid-template-columns: 1fr; }
    .table-charts-container { flex-direction: column; }
    .charts-section { flex-direction: row; }
  }
  @media(max-width:768px){ 
    .charts-section { flex-direction: column; }
  }
</style>
</head>
<body>

<!-- BACKGROUND -->
<img src="/static/images/bg_main.png" class="bg-image" alt="Background" />
<div class="overlay"></div>

<!-- MAIN CARD -->
<div class="card">
  <!-- LEFT: FORM -->
  <div>
    <h1 class="text-2xl font-bold text-indigo-600 mb-4">Simulate New Drug</h1>

    <!-- ðŸ”¼ CSV LOADER for Molecules -->
    <div class="viewer-card p-3 mb-4">
      <label class="text-white mb-2">Load Drug CSV (columns accepted: <code>name</code>, <code>smiles</code>, <code>cid</code>)</label>
      <input id="csvFile" type="file" accept=".csv" class="w-full p-2 rounded-lg border" />
      <p class="text-xs text-gray-200 mt-1">Tip: Include ~20 common drugs. SMILES preferred. CID also works.</p>
    </div>

    <form id="predictForm" class="space-y-2">
      <div>
        <label>Drug Name</label>
        <input name="drug_name" required placeholder="e.g. MyPainRelief" />
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label>Race</label>
          <select name="race" required>
            <option value="">--Select--</option>
            <option>Malay</option>
            <option>Chinese</option>
            <option>Indian</option>
            <option>Indigenous</option>
          </select>
        </div>
        <div>
          <label>Gender</label>
          <select name="gender" required>
            <option value="">--Select--</option>
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label>Age</label>
          <input name="age" type="number" min="0" required />
        </div>
        <div>
          <label class="block mb-2">Concentration (mg/mL)</label>
          <input name="concentration" id="concentration" type="number" step="any" min="0" placeholder="e.g. 5" class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300" />
        </div>
        <div class="grid grid-cols-2 gap-4 col-span-2">
          <div>
            <label class="block mb-2">Dosage (mg)</label>
            <input name="dosage_mg" id="dosageMg" type="number" step="any" min="0" placeholder="e.g. 500" class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300" />
          </div>
          <div>
            <label class="block mb-2">Dosage (mL)</label>
            <input name="dosage_ml" id="dosageMl" type="number" step="any" min="0" placeholder="auto-calculated" class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300" />
          </div>
        </div>
      </div>

      <div>
        <label>Target Symptom / Disease</label>
        <select name="target_symptom" id="targetSymptom" required>
          <option value="">--Select--</option>
          <option>Fever</option>
          <option>Cough</option>
          <option>Headache</option>
          <option>Flu</option>
          <option>Sore Throat</option>
          <option>Colon Cancer</option>
          <option>Breast Cancer</option>
          <option>Breast Cancer (HER2+)</option>
          <option>Lung Cancer</option>
          <option>Leukemia</option>
          <option>Lymphoma</option>
          <option>Pancreatic Cancer</option>
          <option>Melanoma</option>
        </select>
      </div>
      <div>
        <label>Line of Treatment</label>
        <select name="line_of_treatment" id="lineOfTreatment" required>
          <option value="General">General</option>
          <option value="First-Line">First-Line</option>
          <option value="Second-Line">Second-Line</option>
          <option value="Targeted">Targeted</option>
        </select>
      </div>

      <!-- HEALTH CONDITION DROPDOWN -->
      <div class="mt-4">
        <label class="block mb-2 text-white">Health Condition</label>
        <select name="health_condition" class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300 text-black">
          <option value="">-- Select --</option>
          <option value="none">None</option>
          <option value="liver_disease">Liver Disease</option>
          <option value="kidney_disease">Kidney Disease</option>
          <option value="asthma">Asthma</option>
          <option value="heart_disease">Heart Disease</option>
          <option value="hypertension">Hypertension</option>
          <option value="pregnancy">Pregnancy</option>
          <option value="glaucoma">Glaucoma</option>
          <option value="elderly">Elderly (Sedation Risk)</option>
        </select>
      </div>

      <div>
        <label>Ingredients <span class="text-xs text-gray-500">(separate with ;)</span></label>
        <input name="ingredients" id="ingredientsInput" placeholder="e.g. Paracetamol;Caffeine" required />
      </div>
      <div class="flex flex-wrap gap-2 mt-2">
        <button type="submit" class="btn-main btn-login flex-1">Simulate</button>
        <button type="button" id="clearBtn" class="btn-main btn-register">Clear</button>
      </div>
      <p id="runMessage" class="text-sm text-gray-200 mt-1"></p>
    </form>

    <!-- ðŸ”¬ Molecule Controls (auto-fills from Ingredients & CSV) -->
    <div class="viewer-card p-4 mt-4">
      <div class="flex items-end gap-2 flex-wrap">
        <div class="flex-1 min-w-[220px]">
          <label class="text-white">Select Ingredient / Drug</label>
          <select id="ingredientSelect" class="w-full p-2 rounded-lg border"></select>
        </div>
        <div>
          <button id="showMolBtn" class="btn-main btn-action">Show 3D Structure</button>
        </div>
      </div>
      <p id="molStatus" class="text-xs text-gray-200 mt-2"></p>
      <div id="molViewer" class="mt-3"></div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="styleStick" class="btn-main btn-login">Sticks</button>
        <button id="styleSphere" class="btn-main btn-register">Spheres</button>
        <button id="styleLine" class="btn-main btn-action">Lines</button>
        <button id="resetView" class="btn-main" style="background:#111827;color:#fff">Reset View</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: OUTPUT PANEL -->
  <div id="outputPanel" class="space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-semibold text-green-700">Simulation Result</h2>
      <div id="badge" class="text-sm text-white font-medium"></div>
    </div>

    <div class="flex gap-4 flex-wrap">
      <div>
        <p class="text-sm text-white">Effectiveness</p>
        <div id="effectiveness" class="text-lg font-bold text-green-800">â€”</div>
      </div>
      <div>
        <p class="text-sm text-white">Side Effect Risk</p>
        <div id="sideEffect" class="text-lg font-semibold text-yellow-700">â€”</div>
      </div>
      <div>
        <p class="text-sm text-white">Success Rate</p>
        <div id="successRate" class="text-lg font-semibold text-blue-700">â€”</div>
      </div>
    </div>

    <div id="bestMatchBox" class="mt-4 p-3 border rounded bg-gray-50 text-sm"></div>

    <div class="mt-2">
      <p class="text-sm text-white font-semibold">Why These Predictions?</p>
      <div id="newDrugReasons" class="text-sm text-gray-200 space-y-1"></div>
    </div>

    <div>
      <p class="text-sm text-white">Likely Side Effects</p>
      <div id="specificSideEffects" class="text-sm text-white">â€”</div>
    </div>

    <div id="matchInfo" class="p-3 rounded border border-gray-200 bg-gray-50">
      <div id="matchMessage" class="text-black font-bold mt-4"></div>
    </div>

    <div>
      <h3 class="text-md font-medium text-white mb-2">Top Matches</h3>
      <div id="matchesList" class="space-y-2"></div>
    </div>

    <div class="text-center">
      <div id="matchedImageArea" class="mb-2"></div>
      <div id="matchedName" class="text-sm font-semibold text-white"></div>
    </div>

    <!-- NEW: TABLE AND CHARTS SIDE BY SIDE -->
    <div class="table-charts-container">
      <div class="table-section">
        <div class="overflow-x-auto">
          <table class="table-auto w-full text-sm text-left text-gray-600">
            <thead class="bg-blue-50">
              <tr>
                <th class="px-3 py-2">Attribute</th>
                <th class="px-3 py-2">New Drug</th>
                <th class="px-3 py-2">Known Medicine</th>
              </tr>
            </thead>
            <tbody id="comparisonTableBody" class="align-top"></tbody>
          </table>
        </div>
      </div>

      <div class="charts-section">
        <div class="radar-wrap">
          <div class="radar-title">Drug Comparison</div>
          <canvas id="radarChart"></canvas>
        </div>
        <div class="radar-wrap">
          <div class="radar-title">Ethnicity Comparison</div>
          <canvas id="ethnicityRadarChart"></canvas>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-bold text-center">Patient Recovery Simulation (6 Months)</h2>
      <canvas id="rollerChart" width="400" height="200"></canvas>
    </div>

    <!-- ðŸ”§ Explanation Section -->
    <div id="explanationSection" class="mt-6 p-4 rounded-xl bg-gray-800 bg-opacity-50 text-white hidden">
      <h3 class="text-lg font-semibold mb-2">Explanation</h3>
      <div id="explanationText" class="text-sm leading-relaxed"></div>
    </div>

    <div class="mt-4 text-center">
      <button id="downloadPDF" class="btn-action">Download as PDF</button>
    </div>
  </div>
</div>

<script>
// ============================ UTILITIES ============================
let radarChartInstance = null;
let ethnicityChartInstance = null;
let rollerChartInstance = null;
let viewer = null; // 3Dmol viewer
let currentModel = null;

function formatSideEffects(text) {
  if (!text) return '-';
  return '<ul class="list-disc list-inside">' + text.split(';').map(s => `<li>${s.trim()}</li>`).join('') + '</ul>';
}

const concInput = document.getElementById("concentration");
const mgInput = document.getElementById("dosageMg");
const mlInput = document.getElementById("dosageMl");

function updateFromMg() {
  const conc = parseFloat(concInput.value);
  const mg = parseFloat(mgInput.value);
  if (!isNaN(conc) && conc > 0 && !isNaN(mg)) {
    mlInput.value = (mg / conc).toFixed(2);
  }
}
function updateFromMl() {
  const conc = parseFloat(concInput.value);
  const ml = parseFloat(mlInput.value);
  if (!isNaN(conc) && conc > 0 && !isNaN(ml)) {
    mgInput.value = (ml * conc).toFixed(2);
  }
}
mgInput.addEventListener("input", updateFromMg);
mlInput.addEventListener("input", updateFromMl);
concInput.addEventListener("input", () => {
  if (mgInput.value) updateFromMg();
  else if (mlInput.value) updateFromMl();
});

// ============================ IMAGE MAP ============================
const imageMap = {
  "Paracetamol": "Paracetamol.png",
  "Panadol": "Panadol.png",
  "Panadol Extend": "Panadol_Extend.png",
  "Ibuprofen": "Ibuprofen.png",
  "Clarinase": "Clarinase.png",
  "Cetirizine": "Cetirizine.png",
  "Diphenhydramine": "Diphenhydramine.png",
  "Aspirin": "Aspirin.png",
  "Naproxen": "Naproxen.png",
  "Dextromethorphan_Guaifenesin": "Dextromethorphan_Guaifenesin.png",
  "Pseudoephedrine": "Pseudoephedrine.png",
  "Loratadine": "Loratadine.png",
  "Mefenamic_Acid": "Mefenamic_Acid.png",
  "5-FU + Leucovorin": "5FU_Leucovorin.png",
  "FOLFOX (Oxaliplatin + 5-FU + Leucovorin)": "FOLFOX.png",
  "FOLFIRI (Irinotecan + 5-FU + Leucovorin)": "FOLFIRI.png",
  "Gemcitabine": "Gemcitabine.png",
  "Paclitaxel": "Paclitaxel.png",
  "Doxorubicin": "Doxorubicin.png",
  "Cyclophosphamide": "Cyclophosphamide.png",
  "Methotrexate": "Methotrexate.png",
  "Cisplatin": "Cisplatin.png",
  "Carboplatin": "Carboplatin.png",
  "Imatinib": "Imatinib.png",
  "Trastuzumab": "Trastuzumab.png",
  "Bevacizumab": "Bevacizumab.png",
  "Nivolumab": "Nivolumab.png",
  "Pembrolizumab": "Pembrolizumab.png",
  "Generic": "Generic.png"
};
function imagePathFor(medName) {
  if (!medName) return "/static/images/Generic.png";
  if (imageMap[medName]) return `/static/images/${imageMap[medName]}`;
  const underscoreName = medName.replace(/\s+/g, "_");
  return `/static/images/${underscoreName}.png`;
}

// ============================ AUTO TREATMENT ============================
const targetSymptomEl = document.getElementById('targetSymptom');
const lineOfTreatmentEl = document.getElementById('lineOfTreatment');
const autoTreatmentMap = {
  "Breast Cancer (HER2+)": "Targeted",
  "Breast Cancer": "First-Line",
  "Colon Cancer": "First-Line",
  "Lung Cancer": "First-Line",
  "Leukemia": "Targeted",
  "Lymphoma": "First-Line",
  "Pancreatic Cancer": "Second-Line",
  "Melanoma": "Targeted",
  "Fever": "General", "Cough": "General", "Headache": "General", "Flu": "General", "Sore Throat": "General"
};

targetSymptomEl.addEventListener('change', () => {
  const selected = targetSymptomEl.value;
  lineOfTreatmentEl.value = autoTreatmentMap[selected] || 'General';
});

// ============================ 3D MOLECULES: CSV + VIEWER ============================
const csvFileInput = document.getElementById('csvFile');
const ingredientSelect = document.getElementById('ingredientSelect');
const ingredientsInput = document.getElementById('ingredientsInput');
const showMolBtn = document.getElementById('showMolBtn');
const molStatus = document.getElementById('molStatus');
const molViewerDiv = document.getElementById('molViewer');

// Internal index: { nameLower: {name, smiles?, cid?} }
let drugIndex = {};

function normalizeName(s){ return (s||'').trim(); }
function toKey(s){ return normalizeName(s).toLowerCase(); }

function rebuildIngredientOptions(filterNames=[]) {
  const set = new Set();
  // 1) From CSV index
  Object.values(drugIndex).forEach(r => set.add(r.name));
  // 2) From typed Ingredients (in case not in CSV yet)
  filterNames.forEach(n => set.add(n));

  const all = Array.from(set).sort((a,b)=>a.localeCompare(b));
  ingredientSelect.innerHTML = '';
  all.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    ingredientSelect.appendChild(opt);
  });
}

// Parse CSV and build index
csvFileInput.addEventListener('change', () => {
  const file = csvFileInput.files[0];
  if (!file) return;
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      drugIndex = {};
      (results.data || []).forEach(row => {
      // âœ… Now supports your CSV's "medicine_name" column
      const name = normalizeName(row.medicine_name || row.name || row.drug || row.medicine || '');
      if (!name) return;

      const rec = { name };
      
      if (row.smiles) rec.smiles = row.smiles.trim();
      if (row.cid) rec.cid = String(row.cid).replace(/\D/g,'');
      
      drugIndex[toKey(name)] = rec;
    });

      // Refresh dropdown (also include any current typed ingredients)
      const typed = (ingredientsInput.value || '').split(';').map(s=>normalizeName(s)).filter(Boolean);
      rebuildIngredientOptions(typed);
      molStatus.textContent = `Loaded ${Object.keys(drugIndex).length} entries from CSV.`;
    },
    error: (err) => {
      molStatus.textContent = `CSV error: ${err.message || err}`;
    }
  });
});

// Rebuild options whenever Ingredients change
ingredientsInput.addEventListener('input', () => {
  const typed = (ingredientsInput.value || '').split(';').map(s=>normalizeName(s)).filter(Boolean);
  rebuildIngredientOptions(typed);
});

// Init viewer once
function ensureViewer(){
  if (!viewer) {
    viewer = $3Dmol.createViewer(molViewerDiv, { backgroundColor: 'white' });
  }
}

function clearViewer(){
  if (!viewer) return;
  viewer.clear();
  viewer.zoomTo();
  viewer.render();
}

// Load SDF from PubChem using CID
async function loadFromCID(cid){
  const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/SDF?record_type=3d`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('PubChem CID fetch failed');
  return await res.text();
}

// Load SDF from PubChem using SMILES
async function loadFromSMILES(smiles){
  const enc = encodeURIComponent(smiles);
  const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${enc}/SDF?record_type=3d`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('PubChem SMILES fetch failed');
  return await res.text();
}

// Try multiple strategies to get SDF text
async function getSDFForName(name){
  const key = toKey(name);
  const rec = drugIndex[key];

  // Priority: SMILES -> CID -> fallback: try name as SMILES (rare) -> name lookup via PubChem (fast name->SDF)
  try {
    if (rec && rec.smiles) return await loadFromSMILES(rec.smiles);
    if (rec && rec.cid) return await loadFromCID(rec.cid);
  } catch (e) {
    console.warn('Primary fetch failed, will try name search.', e);
  }
  // Name lookup by PubChem (uses name as a 'name' identifier)
  try {
    const enc = encodeURIComponent(name);
    const urlCid = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${enc}/cids/TXT`;
    const cidTxt = await fetch(urlCid).then(r=>r.ok?r.text():Promise.reject('name->cid failed'));
    const cid = (cidTxt||'').split(/\s+/)[0];
    if (cid) return await loadFromCID(cid);
  } catch (e){
    console.warn('Name->CID failed', e);
  }
  throw new Error('Unable to resolve structure for ' + name);
}

function applyStyle(style){
  if (!viewer || !currentModel) return;
  const styles = {
    sticks: { stick: {} },
    spheres: { sphere: {} },
    lines: { line: {} }
  };
  viewer.setStyle({}, styles[style] || { stick: {} });
  viewer.render();
}

document.getElementById('styleStick').addEventListener('click', ()=>applyStyle('sticks'));
document.getElementById('styleSphere').addEventListener('click', ()=>applyStyle('spheres'));
document.getElementById('styleLine').addEventListener('click', ()=>applyStyle('lines'));
document.getElementById('resetView').addEventListener('click', ()=>{ if(viewer){ viewer.zoomTo(); viewer.render(); } });

document.getElementById('showMolBtn').addEventListener('click', async ()=>{
  const name = ingredientSelect.value;
  if (!name) { molStatus.textContent = 'Pick a molecule first.'; return; }
  ensureViewer();
  molStatus.textContent = 'Fetching 3D structure from PubChemâ€¦';
  try {
    const sdf = await getSDFForName(name);
    clearViewer();
    currentModel = viewer.addModel(sdf, 'sdf');
    viewer.setStyle({}, { stick: {} });
    viewer.addSurface($3Dmol.SurfaceType.SAS, { opacity: 0.15 });
    viewer.zoomTo();
    viewer.render();
    molStatus.textContent = `Showing: ${name}`;
  } catch (err){
    console.error(err);
    molStatus.textContent = `Could not load structure for ${name}.`;
  }
});

// ============================ FORM + CHARTS (existing logic, lightly adjusted) ============================
const form = document.getElementById('predictForm');
const outputPanel = document.getElementById('outputPanel');
const runMessage = document.getElementById('runMessage');
const effectivenessEl = document.getElementById('effectiveness');
const sideEffectEl = document.getElementById('sideEffect');
const successRateEl = document.getElementById('successRate');
const specificSideEffectsEl = document.getElementById('specificSideEffects');
const matchesList = document.getElementById('matchesList');
const matchMessage = document.getElementById('matchMessage');
const matchedImageArea = document.getElementById('matchedImageArea');
const matchedName = document.getElementById('matchedName');
const comparisonTableBody = document.getElementById('comparisonTableBody');
const badge = document.getElementById('badge');
const clearBtn = document.getElementById('clearBtn');

clearBtn.addEventListener('click', () => {
  form.reset();
  outputPanel.style.display = 'none';
  runMessage.textContent = '';
  matchesList.innerHTML = '';
  matchMessage.textContent = '';
  matchedImageArea.innerHTML = '';
  matchedName.textContent = '';
  comparisonTableBody.innerHTML = '';
  if (radarChartInstance) { radarChartInstance.destroy(); radarChartInstance = null; }
  if (ethnicityChartInstance) { ethnicityChartInstance.destroy(); ethnicityChartInstance = null; }
  if (rollerChartInstance) { rollerChartInstance.destroy(); rollerChartInstance = null; }
  clearViewer();
});

function generateSimulationCurve(drug) {
  const months = [0,1,2,3,4,5,6];
  const values = [];
  const successRate = Number(drug.success_rate) || 0;
  const effectiveness = Number(drug.effectiveness) || 0;
  const risk = (drug.side_effect_risk || '').toLowerCase();
  months.forEach(m => {
    let heal = successRate * (1 - Math.exp(-(effectiveness/100)*m));
    if (risk === 'medium' && m===3) heal -= 5;
    if (risk === 'high' && (m===2 || m===5)) heal -= 10;
    values.push(Math.max(0, Math.min(100, Math.round(heal))));
  });
  return { months, values };
}
function generateHybridCurve(drug, aiAdjustments){
  const months = [0,1,2,3,4,5,6];
  const values = [];
  const successRate = Number(drug.success_rate) || 0;
  const effectiveness = Number(drug.effectiveness) || 0;
  const risk = (drug.side_effect_risk || '').toLowerCase();
  months.forEach((m, idx)=>{
    let heal = successRate * (1 - Math.exp(-(effectiveness/100)*m));
    if (risk === 'medium' && m===3) heal -= 5;
    if (risk === 'high' && (m===2 || m===5)) heal -= 10;
    const aiFactor = aiAdjustments && aiAdjustments[idx] ? aiAdjustments[idx] : 1;
    heal = heal * aiFactor;
    values.push(Math.max(0, Math.min(100, Math.round(heal))));
  });
  return { months, values };
}
function addWiggle(values, magnitude=3){
  return values.map(v=>{ const d=(Math.random()*2-1)*magnitude; return Math.max(0, Math.min(100, Math.round(v+d))); });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  runMessage.textContent = 'Sending to server...';
  outputPanel.style.display = 'none';
  matchesList.innerHTML = '';
  matchMessage.textContent = '';
  matchedImageArea.innerHTML = '';
  matchedName.textContent = '';
  comparisonTableBody.innerHTML = '';
  if (radarChartInstance) { radarChartInstance.destroy(); radarChartInstance = null; }

  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  const selectedCondition = formData.get('health_condition');
  data.health_conditions = selectedCondition && selectedCondition !== 'none' ? [selectedCondition] : [];

  try {
    const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
    const result = await res.json();
    if (res.status !== 200) { runMessage.textContent = result.error || 'Server returned an error'; return; }
    runMessage.textContent = '';
    outputPanel.style.display = 'block';

    effectivenessEl.textContent = (result.predicted_effectiveness ?? '-') + '%';
    sideEffectEl.textContent = result.predicted_side_effect_risk ?? '-';
    successRateEl.textContent = (result.predicted_success_rate ?? '-') + '%';

    const reasonsBox = document.getElementById('newDrugReasons');
    reasonsBox.innerHTML = '';
    if (result.new_drug_note) {
      const warn = document.createElement('div');
      warn.className = 'bg-red-100 text-red-800 rounded px-2 py-1 text-sm';
      warn.textContent = result.new_drug_note;
      reasonsBox.appendChild(warn);
    }
    if (result.new_drug_explanations) {
      result.new_drug_explanations.forEach(msg => {
        if (msg && msg.trim() !== '') {
          const div = document.createElement('div');
          div.textContent = 'â€¢ ' + msg;
          reasonsBox.appendChild(div);
        }
      });
    }
    if (result.explanations) {
      const exp = result.explanations;
      const html = `
        <p><b>Effectiveness:</b> ${exp.effectiveness || '-'}</p>
        <p><b>Side Effects:</b> ${exp.side_effects || '-'}</p>
        <p><b>Success Rate:</b> ${exp.success_rate || '-'}</p>`;
      reasonsBox.innerHTML += html;
    }

    const matchBox = document.getElementById('bestMatchBox');
    if (matchBox) {
      matchBox.innerHTML = `
        <h3 class="text-lg font-semibold mb-1">Best Match</h3>
        <p><b>Medicine:</b> ${result.best_match?.medicine_name || 'No match found'}</p>
        <p><b>Similarity Score:</b> ${result.best_match?.percent ?? 0}%</p>
        ${result.escalation_applied ? `<p class="text-yellow-600"><b>Note:</b> Escalated to ${result.input_summary.line_of_treatment}</p>` : ''}
      `;
    }

    if (result.strong_match && result.best_match) {
      badge.textContent = `Strong match: ${result.best_match.medicine_name} (${result.best_match.percent ?? 0}%)`;
      matchMessage.textContent = `Best match: ${result.best_match.medicine_name} â€” ${result.best_match.percent ?? 0}% similarity.`;
    } else {
      badge.textContent = 'No strong match';
      matchMessage.textContent = result.message || 'No strong match found.';
    }

    (result.top_matches || []).forEach(m => {
      const card = document.createElement('div');
      card.innerHTML = `
        <div class="text-sm font-semibold">${m.medicine_name} <span class="text-xs text-gray-500">(${m.target_symptom})</span></div>
        <div class="text-xs text-gray-600">Match: <strong>${m.percent}%</strong></div>
        <div class="text-xs text-gray-600"><strong>Active:</strong> ${(m.ingredients_active || []).join(', ') || '-'}</div>
        <div class="text-xs text-gray-600"><strong>Inactive:</strong> ${(m.ingredients_inactive || []).join(', ') || '-'}</div>
        <div class="text-xs text-gray-600"><strong>Known side effects:</strong> ${formatSideEffects(m.known_side_effects)}</div>`;
      matchesList.appendChild(card);
    });

    const best = result.best_match || (result.top_matches && result.top_matches[0]);
    if (best) {
      const img = document.createElement('img');
      img.alt = best.medicine_name;
      img.src = imagePathFor(best.medicine_name);
      img.onerror = () => img.src = '/static/images/Generic.png';
      matchedImageArea.appendChild(img);
      matchedName.textContent = best.medicine_name;

      const newDrug = {
        drug_name: data.drug_name,
        ingredients: data.ingredients,
        dosage_mg: data.dosage_mg || data.dosageMg || '-',
        line_of_treatment: data.line_of_treatment || data.lineOfTreatment || '-',
        target_symptom: data.target_symptom,
        health_condition: data.health_conditions || [],
        effectiveness: result.predicted_effectiveness,
        success_rate: result.predicted_success_rate,
        side_effect_risk: result.predicted_side_effect_risk,
        predicted_specific_side_effects: result.predicted_specific_side_effects || []
      };

      const fmtSE = (effects) => {
        if (!effects || effects === '-') return '-';
        if (Array.isArray(effects)) return effects.join(', ');
        return effects.split(/[,;]+/).map(e => e.trim()).filter(Boolean).join(', ');
      };

      comparisonTableBody.innerHTML = '';
      const rows = [
        ['Drug Name', newDrug.drug_name || '-', best.medicine_name || '-'],
        ['Target Symptom', newDrug.target_symptom || '-', best.target_symptom || '-'],
        ['Line of Treatment', newDrug.line_of_treatment || '-', best.line_of_treatment || '-'],
        ['Health Condition', (newDrug.health_condition || []).join(', ') || '-', best.health_condition || '-'],
        ['Ingredients', newDrug.ingredients || '-', (((best.ingredients_active || []).join(', ')) + (best.ingredients_inactive?.length ? ' (inactive: ' + best.ingredients_inactive.join(', ') + ')' : '')) || '-'],
        ['Dosage (mg)', newDrug.dosage_mg || '-', best.dosage_mg || '-'],
        ['Effectiveness', `${newDrug.effectiveness}%`, best.effectiveness ? best.effectiveness + '%' : '-'],
        ['Success Rate', `${newDrug.success_rate}%`, best.success_rate ? best.success_rate + '%' : '-'],
        ['Side Effect Risk', newDrug.side_effect_risk || '-', best.side_effect_risk || '-'],
        ['Likely Side Effects', fmtSE(newDrug.predicted_specific_side_effects), fmtSE(best?.known_side_effects || '-')]
      ];
      rows.forEach(([label, a, b]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-3 py-2 font-semibold">${label}</td><td class="px-3 py-2">${a}</td><td class="px-3 py-2">${b}</td>`;
        comparisonTableBody.appendChild(tr);
      });

      const safetyMap = { 'Low': 100, 'Medium': 50, 'High': 10 };
      const ndEffect = Number(newDrug.effectiveness) || 0;
      const ndSuccess = Number(newDrug.success_rate) || 0;
      const ndSafety = safetyMap[newDrug.side_effect_risk] ?? 0;
      const ndDosageScaled = Math.min(100, Number(newDrug.dosage_mg) || 0) / 10;
      const ndIngCount = (newDrug.ingredients || '').split(';').filter(x => x.trim()).length * 10;
      const knEffect = Number(best.effectiveness) || 0;
      const knSuccess = Number(best.success_rate) || 0;
      const knSafety = safetyMap[best.side_effect_risk] ?? 0;
      const knDosageScaled = Math.min(100, Number(best.dosage_mg) || 0) / 10;
      const knIngCount = (best.ingredients_active || []).length * 10;

      const ctx = document.getElementById('radarChart').getContext('2d');
      if (radarChartInstance) radarChartInstance.destroy();
      radarChartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Effectiveness', 'Success', 'Safety', 'Dosage', '#Ingredients'],
          datasets: [
            { label: 'New Drug', data: [ndEffect, ndSuccess, ndSafety, ndDosageScaled, ndIngCount], backgroundColor: 'rgba(79,70,229,0.2)', borderColor: '#4f46e5', pointBackgroundColor: '#4f46e5', fill: true, borderWidth: 2 },
            { label: 'Known Medicine', data: [knEffect, knSuccess, knSafety, knDosageScaled, knIngCount], backgroundColor: 'rgba(16,185,129,0.2)', borderColor: '#10b981', pointBackgroundColor: '#10b981', fill: true, borderWidth: 2 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'white' } } }, scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20, color: '#6b7280', backdropColor: 'transparent' }, angleLines: { color: '#d1d5db' }, grid: { color: '#e5e7eb' }, pointLabels: { color: 'white', font: { size: 12 } } } } }
      });

      const ctx2 = document.getElementById('ethnicityRadarChart').getContext('2d');
      const labels = ["Malay", "Chinese", "Indian", "Indigenous"];
      const newDrugData = labels.map(l => result.ethnicity_scores?.new_drug?.[l] ?? 0);
      const knownMedData = labels.map(l => result.ethnicity_scores?.known_medicine?.[l] ?? 0);
      const selectedEthnicity = data.race || '';
      if (ethnicityChartInstance) ethnicityChartInstance.destroy();
      ethnicityChartInstance = new Chart(ctx2, {
        type: 'radar',
        data: { labels, datasets: [
          { label: 'New Drug', data: newDrugData, borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.2)', pointBackgroundColor: newDrugData.map((_,i)=> labels[i]===selectedEthnicity?'yellow':'#4f46e5'), pointBorderColor: newDrugData.map((_,i)=> labels[i]===selectedEthnicity?'yellow':'#4f46e5') },
          { label: 'Known Medicine', data: knownMedData, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.2)', pointBackgroundColor: knownMedData.map((_,i)=> labels[i]===selectedEthnicity?'yellow':'#10b981'), pointBorderColor: knownMedData.map((_,i)=> labels[i]===selectedEthnicity?'yellow':'#10b981') }
        ]},
        options: { responsive: true, plugins: { legend: { labels: { color: 'white' } }, title: { display: true, text: 'Drug Performance by Ethnicity', color: 'white' } }, scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20, color: 'white' }, angleLines: { color: 'rgba(255,255,255,0.2)' }, grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: 'white', font: { size: 12 } } } } }
      });

      const ndAiAdjustments = result.ai_curve_new_drug || [1,1,1,1,1,1,1];
      const bmAiAdjustments = result.ai_curve_best_match || [1,1,1,1,1,1,1];
      const ndCurve = generateHybridCurve(newDrug, ndAiAdjustments);
      const bmCurve = generateHybridCurve(best, bmAiAdjustments);
      ndCurve.values = addWiggle(ndCurve.values, 3);
      bmCurve.values = addWiggle(bmCurve.values, 3);

      const ctxRoller = document.getElementById('rollerChart').getContext('2d');
      if (rollerChartInstance) rollerChartInstance.destroy();
      rollerChartInstance = new Chart(ctxRoller, {
        type: 'line',
        data: { labels: ndCurve.months.map(m=>`Month ${m}`), datasets: [
          { label: newDrug.drug_name || 'New Drug', data: ndCurve.values, borderColor: 'rgba(75,192,192,1)', backgroundColor: 'rgba(75,192,192,0.3)', tension: 0.4, fill: true },
          { label: best.medicine_name || 'Best Match', data: bmCurve.values, borderColor: 'rgba(255,99,132,1)', backgroundColor: 'rgba(255,99,132,0.3)', tension: 0.4, fill: true }
        ]},
        options: { responsive: true, plugins: { title: { display: true, text: 'Predicted Patient Healing Over 6 Months', color: 'white', font: { size: 16 } }, legend: { labels: { color: 'white' } }, tooltip: { mode: 'index', intersect: false } }, interaction: { mode: 'nearest', axis: 'x', intersect: false }, scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Patient Cure/Healing (%)', color: 'white' }, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { title: { display: true, text: 'Months', color: 'white' }, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } } } }
      });
    }
  } catch (err) {
    console.error(err);
    runMessage.textContent = 'Server Error';
  }
});

// ------------------------- PDF DOWNLOAD (rest) -------------------------
document.getElementById('downloadPDF').addEventListener('click', async () => {
  const btn = document.getElementById('downloadPDF');
  const section = document.getElementById('outputPanel');

  if (!section) {
    console.error('No outputPanel found to render to PDF.');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Rendering PDF...';

  try {
    // Capture the visible output panel (includes charts, tables, and text)
    const canvas = await html2canvas(section, { scale: 2, useCORS: true, allowTaint: true });
    const imgData = canvas.toDataURL('image/png');

    // Use jspdf UMD build
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Fit width with small margin
    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let position = 10;
    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);

    // If content is longer than one page, add pages
    let heightLeft = imgHeight - (pageHeight - 20);
    while (heightLeft > 0) {
      pdf.addPage();
      // position - heightLeft positions the same image shifted up to show next slice
      pdf.addImage(imgData, 'PNG', 10, position - heightLeft, imgWidth, imgHeight);
      heightLeft -= (pageHeight - 20);
    }

    pdf.save(`simulation_result_${Date.now()}.pdf`);
    btn.textContent = 'Download as PDF';
  } catch (err) {
    console.error('PDF generation failed', err);
    btn.textContent = 'Download as PDF';
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
