<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PharmaSim AI — Enhanced Simulation with Molecular View</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
<style>
/* ------------------------- BODY & BACKGROUND ------------------------- */
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: start;
  padding-top: 2rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  overflow-x: hidden;
}

.bg-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at 30% 40%, rgba(120, 119, 198, 0.3), transparent 50%),
              radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15), transparent 50%),
              radial-gradient(circle at 40% 80%, rgba(120, 219, 226, 0.15), transparent 50%);
  z-index: -1;
}

/* ------------------------- CARD LAYOUT ------------------------- */
.card {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  width: 100%;
  max-width: 1200px;
  overflow: hidden;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  padding: 2rem;
  animation: fadeIn 0.8s ease-out;
  border: 1px solid rgba(255, 255, 255, 0.3);
}
@keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

/* ------------------------- FORM ------------------------- */
form label {
  font-weight: 600;
  margin-bottom: 0.25rem;
  display: block;
  color: white;
}
form input, form select {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  margin-bottom: 1rem;
  transition: all 0.2s;
}
form input:focus, form select:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 2px rgba(79,70,229,0.2);
}

/* ------------------------- BUTTONS ------------------------- */
.btn-main {
  padding: 0.75rem 1.5rem;
  border-radius: 9999px;
  font-weight: bold;
  font-size: 1.1rem;
  margin: 0.25rem 0;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.25s ease;
}
.btn-login { background-color:#4f46e5; color:white; }
.btn-login:hover { background-color:white; color:#4f46e5; border-color:#4f46e5; transform:translateY(-2px) scale(1.05); }
.btn-register { background-color:#10b981; color:white; }
.btn-register:hover { background-color:white; color:#10b981; border-color:#10b981; transform:translateY(-2px) scale(1.05); }
.btn-action { background-color:#f59e0b; color:white; }
.btn-action:hover { background-color:#b45309; }

/* ------------------------- OUTPUT PANEL ------------------------- */
#outputPanel { display:none; margin-top:1rem; color:#1f2937; }

/* ------------------------- TOP MATCHES ------------------------- */
#matchesList > div {
  background: rgba(255,255,255,0.75);
  padding: 0.75rem;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.1);
  transition: transform 0.25s, box-shadow 0.25s;
}
#matchesList > div:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* ------------------------- MOLECULAR VIEWER ------------------------- */
.molecular-section {
  margin-top: 2rem;
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 1.5rem;
  border: 1px solid rgba(255,255,255,0.2);
}

.molecular-title {
  color: white;
  font-size: 1.2rem;
  font-weight: 600;
  text-align: center;
  margin-bottom: 1rem;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.molecule-container {
  display: flex;
  gap: 2rem;
  justify-content: center;
  align-items: flex-start;
}

.molecule-viewer {
  flex: 1;
  text-align: center;
}

.molecule-viewer h4 {
  color: white;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.molecule-3d {
  width: 300px;
  height: 250px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 12px;
  background: #000;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
}

.molecule-fallback {
  width: 300px;
  height: 250px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 12px;
  background: linear-gradient(45deg, #1a1a2e, #16213e);
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  font-size: 0.9rem;
  text-align: center;
  padding: 1rem;
}

.smiles-display {
  color: #e5e7eb;
  font-family: monospace;
  font-size: 0.8rem;
  margin-top: 0.5rem;
  word-break: break-all;
  background: rgba(0,0,0,0.3);
  padding: 0.5rem;
  border-radius: 8px;
}

.similarity-score {
  color: white;
  font-weight: bold;
  text-align: center;
  margin: 1rem 0;
  padding: 0.5rem;
  background: rgba(79,70,229,0.3);
  border-radius: 8px;
}

/* ------------------------- TABLE AND CHARTS LAYOUT ------------------------- */
.table-charts-container {
  display: flex;
  gap: 2rem;
  margin-top: 1.5rem;
  align-items: flex-start;
}

.table-section {
  flex: 1;
  min-width: 0;
}

.charts-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* ------------------------- TABLE ------------------------- */
table { 
  width: 100%; 
  border-collapse: collapse; 
  background: white; 
  border-radius: 12px; 
  overflow: hidden; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
}
th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
th { background: #e0e7ff; font-weight: 600; }
tbody tr:nth-child(even) { background: #f9fafb; }

/* ------------------------- RADAR CHART ------------------------- */
.radar-wrap { 
  position: relative; 
  height: 380px; 
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.radar-title {
  color: white;
  font-size: 1.1rem;
  font-weight: 600;
  text-align: center;
  margin-bottom: 1rem;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* ------------------------- MATCH IMAGE ------------------------- */
#matchedImageArea img { border-radius: 50%; width: 120px; height: 120px; object-fit: cover; margin-bottom: 0.5rem; transition: transform 0.3s; }
#matchedImageArea img:hover { transform: scale(1.1); }
#matchedImageArea {
  display: flex;            
  justify-content: center;  
  align-items: center;      
  margin-bottom: 0.5rem;    
}

/* ------------------------- RESPONSIVE ------------------------- */
@media(max-width:1024px){ 
  .card { grid-template-columns: 1fr; }
  .table-charts-container { flex-direction: column; }
  .charts-section { flex-direction: row; }
  .molecule-container { flex-direction: column; align-items: center; }
}
@media(max-width:768px){ 
  .charts-section { flex-direction: column; }
  .molecule-container { flex-direction: column; }
  .molecule-3d, .molecule-fallback { width: 250px; height: 200px; }
}
</style>
</head>
<body>

<!-- BACKGROUND -->
<div class="bg-overlay"></div>

<!-- MAIN CARD -->
<div class="card">

  <!-- LEFT: FORM -->
  <div>
    <h1 class="text-2xl font-bold text-indigo-600 mb-4">Simulate New Drug</h1>
    <form id="predictForm" class="space-y-2">
      <div>
        <label>Drug Name</label>
        <input name="drug_name" required placeholder="e.g. MyPainRelief">
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label>Race</label>
          <select name="race" required>
            <option value="">--Select--</option>
            <option>Malay</option>
            <option>Chinese</option>
            <option>Indian</option>
            <option>Indigenous</option>
          </select>
        </div>
        <div>
          <label>Gender</label>
          <select name="gender" required>
            <option value="">--Select--</option>
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label>Age</label>
          <input name="age" type="number" min="0" required>
        </div>
        <div>
          <label class="block mb-2">Concentration (mg/mL)</label>
          <input name="concentration" id="concentration" type="number" step="any" min="0" placeholder="e.g. 5"
            class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300">
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block mb-2">Dosage (mg)</label>
          <input name="dosage_mg" id="dosageMg" type="number" step="any" min="0" placeholder="e.g. 500" 
            class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300">
        </div>
        <div>
          <label class="block mb-2">Dosage (mL)</label>
          <input name="dosage_ml" id="dosageMl" type="number" step="any" min="0" placeholder="auto-calculated" 
            class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300">
        </div>
      </div>
      <div>
        <label>Target Symptom / Disease</label>
        <select name="target_symptom" id="targetSymptom" required>
          <option value="">--Select--</option>
          <!-- General conditions -->
          <option>Fever</option>
          <option>Cough</option>
          <option>Headache</option>
          <option>Flu</option>
          <option>Sore Throat</option>
          
          <!-- Oncology conditions -->
          <option>Colon Cancer</option>
          <option>Breast Cancer</option>
          <option>Breast Cancer (HER2+)</option>
          <option>Lung Cancer</option>
          <option>Leukemia</option>
          <option>Lymphoma</option>
          <option>Pancreatic Cancer</option>
          <option>Melanoma</option>
        </select>
      </div>

      <div>
        <label>Line of Treatment</label>
        <select name="line_of_treatment" id="lineOfTreatment" required>
          <option value="General">General</option>
          <option value="First-Line">First-Line</option>
          <option value="Second-Line">Second-Line</option>
          <option value="Targeted">Targeted</option>
        </select>
      </div>

      <!-- HEALTH CONDITION DROPDOWN -->
      <div class="mt-4">
        <label class="block mb-2 text-white">Health Condition</label>
        <select name="health_condition" class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300 text-black">
          <option value="">-- Select --</option>
          <option value="none">None</option>
          <option value="liver_disease">Liver Disease</option>
          <option value="kidney_disease">Kidney Disease</option>
          <option value="asthma">Asthma</option>
          <option value="heart_disease">Heart Disease</option>
          <option value="hypertension">Hypertension</option>
          <option value="pregnancy">Pregnancy</option>
          <option value="glaucoma">Glaucoma</option>
          <option value="elderly">Elderly (Sedation Risk)</option>
        </select>
      </div>
      <div>
        <label>Ingredients <span class="text-xs text-gray-500">(separate with ;)</span></label>
        <input name="ingredients" id="ingredientsInput" placeholder="e.g. Paracetamol;Caffeine" required>
      </div>
      <div class="flex flex-wrap gap-2 mt-2">
        <button type="submit" class="btn-main btn-login flex-1">Simulate</button>
        <button type="button" id="clearBtn" class="btn-main btn-register">Clear</button>
      </div>
      <p id="runMessage" class="text-sm text-gray-200 mt-1"></p>
    </form>
  </div>

  <!-- RIGHT: OUTPUT PANEL -->
  <div id="outputPanel" class="space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-semibold text-green-700">Simulation Result</h2>
      <div id="badge" class="text-sm text-white font-medium"></div>
    </div>

    <div class="flex gap-4 flex-wrap">
      <div>
        <p class="text-sm text-white">Effectiveness</p>
        <div id="effectiveness" class="text-lg font-bold text-green-800">—</div>
      </div>
      <div>
        <p class="text-sm text-white">Side Effect Risk</p>
        <div id="sideEffect" class="text-lg font-semibold text-yellow-700">—</div>
      </div>
      <div>
        <p class="text-sm text-white">Success Rate</p>
        <div id="successRate" class="text-lg font-semibold text-blue-700">—</div>
      </div>
    </div>

    <div id="bestMatchBox" class="mt-4 p-3 border rounded bg-gray-50 text-sm"></div>

    <div class="mt-2">
        <p class="text-sm text-white font-semibold">Why These Predictions?</p>
        <div id="newDrugReasons" class="text-sm text-gray-200 space-y-1"></div>
    </div>

    <div>
      <p class="text-sm text-white">Likely Side Effects</p>
      <div id="specificSideEffects" class="text-sm text-white">—</div>
    </div>

    <div id="matchInfo" class="p-3 rounded border border-gray-200 bg-gray-50">
      <div id="matchMessage" class="text-black font-bold mt-4"></div>
    </div>

    <div>
      <h3 class="text-md font-medium text-white mb-2">Top Matches</h3>
      <div id="matchesList" class="space-y-2"></div>
    </div>

    <div class="text-center">
      <div id="matchedImageArea" class="mb-2"></div>
      <div id="matchedName" class="text-sm font-semibold text-white"></div>
    </div>

    <!-- MOLECULAR VISUALIZATION SECTION -->
    <div id="molecularSection" class="molecular-section" style="display: none;">
      <div class="molecular-title">Molecular Structure Comparison</div>
      <div class="molecule-container">
        <div class="molecule-viewer">
          <h4>Your Drug Ingredients</h4>
          <div id="userMolecule" class="molecule-3d"></div>
          <div id="userSmiles" class="smiles-display"></div>
        </div>
        <div class="similarity-score">
          <div id="molecularSimilarity">Molecular Similarity: Computing...</div>
        </div>
        <div class="molecule-viewer">
          <h4>Best Match Medicine</h4>
          <div id="matchMolecule" class="molecule-3d"></div>
          <div id="matchSmiles" class="smiles-display"></div>
        </div>
      </div>
    </div>

    <!-- TABLE AND CHARTS SIDE BY SIDE -->
    <div class="table-charts-container">
      <!-- TABLE SECTION -->
      <div class="table-section">
        <div class="overflow-x-auto">
          <table class="table-auto w-full text-sm text-left text-gray-600">
            <thead class="bg-blue-50">
              <tr>
                <th class="px-3 py-2">Attribute</th>
                <th class="px-3 py-2">New Drug</th>
                <th class="px-3 py-2">Known Medicine</th>
              </tr>
            </thead>
            <tbody id="comparisonTableBody" class="align-top"></tbody>
          </table>
        </div>
      </div>

      <!-- CHARTS SECTION -->
      <div class="charts-section">
        <div class="radar-wrap">
          <div class="radar-title">Drug Comparison</div>
          <canvas id="radarChart"></canvas>
        </div>

        <div class="radar-wrap">
          <div class="radar-title">Ethnicity Comparison</div>
          <canvas id="ethnicityRadarChart"></canvas>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-bold text-center">Patient Recovery Simulation (6 Months)</h2>
      <canvas id="rollerChart" width="400" height="200"></canvas>
    </div>

    <!-- EXPLANATION SECTION -->
    <div id="explanationSection" class="mt-6 p-4 rounded-xl bg-gray-800 bg-opacity-50 text-white hidden">
      <h3 class="text-lg font-semibold mb-2">Explanation</h3>
      <div id="explanationText" class="text-sm leading-relaxed"></div>
    </div>

    <div class="mt-4 text-center">
      <button id="downloadPDF" class="btn-action">Download as PDF</button>
    </div>
  </div>
</div>

<script>
let radarChartInstance = null;
let ethnicityChartInstance = null;
let rollerChartInstance = null;
let userMolViewer = null;
let matchMolViewer = null;

// SMILES data for molecules
const SMILES_DATA = {
  "Paracetamol": "CC(=O)Nc1ccc(O)cc1",
  "Ibuprofen": "CC(C)Cc1ccc(C(C)C(=O)O)cc1",
  "Aspirin": "CC(=O)Oc1ccccc1C(=O)O",
  "Naproxen": "COc1ccc2cc(C(C)C(=O)O)ccc2c1",
  "Caffeine": "Cn1c(=O)c2c(ncn2C)n(C)c1=O",
  "Clarinase": "CCN(CC)CCOC(c1ccccc1)c1ccccn1",
  "Cetirizine": "COCCN1CCN(CC1)C(c1ccc(Cl)cc1)c1ccccc1",
  "Diphenhydramine": "CN(C)CCOC(c1ccccc1)c1ccccc1",
  "5-FU": "FC1=CNC(=O)NC1=O",
  "Leucovorin": "NC1=NC2=C(C=CC(CNc3ccc(C(=O)NC(CCC(=O)O)C(=O)O)cc3)=C2)C(=O)N1",
  "Oxaliplatin": "[Pt+2]",
  "Irinotecan": "CCN1C=C2C(C[NH+](CC3)CC4=C3C(O)=CC=C4OC(=O)C5=CC6=C(N7CCCC7)C=CC6=C5)=C3C(=CC=C(C)C3=O)N2C1=O",
  "Gemcitabine": "NC1=NC(=O)N(C=C1)[C@@H]1O[C@H](CO)[C@@H](O)[C@H]1F",
  "Paclitaxel": "CC1=C2[C@@H](C[C@H]3[C@H](C)[C@H](OC(=O)[C@H](O)[C@@H](NC(=O)c4ccccc4)c4ccccc4)CC[C@]3(O)C(=O)C2)C(C)(C)CCC1",
  "Doxorubicin": "COc1cccc2c1C(=O)c1c(O)c3c(c(O)c1C2=O)C[C@@](O)(C[C@@H]1O[C@H](C)[C@H](N)[C@H](O)[C@H]1O)C3",
  "Cyclophosphamide": "ClCCN(CCCl)P1(=O)NCCCO1",
  "Methotrexate": "CN(Cc1cnc2nc(N)nc(N)c2n1)c1ccc(C(=O)NC(CCC(=O)O)C(=O)O)cc1",
  "Cisplatin": "[Pt+2]",
  "Carboplatin": "[Pt+2]",
  "Imatinib": "Cc1ccc(NC(=O)c2ccc(CN3CCN(C)CC3)cc2)cc1Nc1nccc(-c2cccnc2)n1",
  "Trastuzumab": "CC(C)(C)OC(=O)N[C@@H](CC1=CC=CC=C1)C(=O)O", // Simplified representation
  "Bevacizumab": "CC(C)(C)OC(=O)N[C@@H](CC1=CC=CC=C1)C(=O)O", // Simplified representation
  "Nivolumab": "CC(C)(C)OC(=O)N[C@@H](CC1=CC=CC=C1)C(=O)O" // Simplified representation
};

// Simple 2D molecular structure representations using SVG
const MOLECULAR_STRUCTURES = {
  "Paracetamol": `<svg width="280" height="220" viewBox="0 0 280 220">
    <g stroke="white" stroke-width="2" fill="none">
      <!-- Benzene ring -->
      <polygon points="100,100 140,80 180,100 180,140 140,160 100,140" stroke="white" fill="none"/>
      <!-- OH group -->
      <line x1="180" y1="100" x2="220" y2="80"/>
      <circle cx="220" cy="80" r="6" fill="red"/>
      <text x="230" y="85" fill="white" font-size="12">OH</text>
      <!-- NH group -->
      <line x1="100" y1="100" x2="60" y2="80"/>
      <circle cx="60" cy="80" r="6" fill="blue"/>
      <text x="40" y="85" fill="white" font-size="12">NH</text>
      <!-- CO-CH3 -->
      <line x1="60" y1="80" x2="30" y2="50"/>
      <circle cx="30" cy="50" r="6" fill="green"/>
      <text x="5" y="55" fill="white" font-size="12">C=O</text>
      <line x1="30" y1="50" x2="30" y2="20"/>
      <text x="20" y="15" fill="white" font-size="12">CH₃</text>
    </g>
  </svg>`,
  
  "Ibuprofen": `<svg width="280" height="220" viewBox="0 0 280 220">
    <g stroke="white" stroke-width="2" fill="none">
      <!-- Benzene ring -->
      <polygon points="120,100 160,80 200,100 200,140 160,160 120,140" stroke="white" fill="none"/>
      <!-- Side chain -->
      <line x1="120" y1="100" x2="80" y2="80"/>
      <line x1="80" y1="80" x2="40" y2="100"/>
      <text x="20" y="105" fill="white" font-size="12">CH₃</text>
      <line x1="80" y1="80" x2="60" y2="50"/>
      <text x="45" y="45" fill="white" font-size="12">CH₃</text>
      <!-- COOH group -->
      <line x1="200" y1="140" x2="240" y2="160"/>
      <circle cx="240" cy="160" r="6" fill="red"/>
      <text x="250" y="165" fill="white" font-size="12">COOH</text>
    </g>
  </svg>`
};

function formatSideEffects(text) {
  if (!text) return '-';
  return '<ul class="list-disc list-inside">' +
    text.split(';').map(s => `<li>${s.trim()}</li>`).join('') +
    '</ul>';
}

// Initialize 3Dmol viewers with better error handling
function initializeMolecularViewers() {
  try {
    // Clear existing viewers
    if (userMolViewer) {
      userMolViewer.clear();
      userMolViewer = null;
    }
    if (matchMolViewer) {
      matchMolViewer.clear();
      matchMolViewer = null;
    }

    const userDiv = document.getElementById('userMolecule');
    const matchDiv = document.getElementById('matchMolecule');

    if (!userDiv || !matchDiv) {
      console.error('Molecule viewer containers not found');
      return;
    }

    userDiv.innerHTML = '';
    matchDiv.innerHTML = '';

    // Check if 3Dmol is available
    if (typeof $3Dmol !== 'undefined') {
      try {
        userMolViewer = $3Dmol.createViewer(userDiv, {
          backgroundColor: '#1a1a2e',
          width: 300,
          height: 250
        });

        matchMolViewer = $3Dmol.createViewer(matchDiv, {
          backgroundColor: '#1a1a2e',
          width: 300,
          height: 250
        });
      } catch (error) {
        console.warn('3Dmol viewer setup failed, using fallback');
        showFallbackMolecule(userDiv, 'User Drug');
        showFallbackMolecule(matchDiv, 'Match Drug');
      }
    } else {
      console.warn('3Dmol library not loaded, using fallback');
      showFallbackMolecule(userDiv, 'User Drug');
      showFallbackMolecule(matchDiv, 'Match Drug');
    }
  } catch (error) {
    console.error('Error initializing molecular viewers:', error);
    showFallbackMolecule(document.getElementById('userMolecule'), 'User Drug');
    showFallbackMolecule(document.getElementById('matchMolecule'), 'Match Drug');
  }
}

// Show fallback molecule representation
function showFallbackMolecule(container, title) {
  container.innerHTML = `
    <div class="molecule-fallback">
      <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⚗️</div>
      <div style="font-size: 0.9rem; opacity: 0.8;">${title}</div>
      <div style="font-size: 0.7rem; margin-top: 0.5rem; opacity: 0.6;">
        3D Structure<br>Visualization
      </div>
    </div>
  `;
}

// Enhanced molecule display function with better error handling
function displayMolecule(viewer, smiles, name, fallbackContainer) {
  if (!viewer || !smiles) {
    if (fallbackContainer) {
      showFallbackMolecule(fallbackContainer, name);
    }
    return;
  }
  
  try {
    viewer.clear();
    
    // Try to add molecule from SMILES
    viewer.addModel(smiles, "smi");
    viewer.setStyle({}, {
      stick: {
        colorscheme: 'Jmol',
        radius: 0.2
      },
      sphere: {
        colorscheme: 'Jmol',
        scale: 0.3
      }
    });
    viewer.zoomTo();
    viewer.render();
    
    // Add a simple loading check
    setTimeout(() => {
      if (viewer.getModel().selectedAtoms({}).length === 0) {
        console.warn(`No atoms found for ${name}, showing fallback`);
        if (fallbackContainer) {
          showFallbackMolecule(fallbackContainer, name);
        }
      }
    }, 1000);
    
  } catch (error) {
    console.warn(`Could not render molecule for ${name}:`, error);
    if (fallbackContainer) {
      showFallbackMolecule(fallbackContainer, name);
    }
  }
}

// Calculate molecular similarity with improved algorithm
function calculateMolecularSimilarity(smiles1, smiles2) {
  if (!smiles1 || !smiles2) return 0;
  
  // Convert to lowercase for comparison
  const s1 = smiles1.toLowerCase();
  const s2 = smiles2.toLowerCase();
  
  // Calculate character-based similarity
  const set1 = new Set(s1.split(''));
  const set2 = new Set(s2.split(''));
  
  const intersection = new Set([...set1].filter(x => set2.has(x)));
  const union = new Set([...set1, ...set2]);
  
  let similarity = (intersection.size / union.size) * 100;
  
  // Bonus for common functional groups
  const functionalGroups = ['OH', 'COOH', 'NH2', 'C=O', 'benzene'];
  let bonusPoints = 0;
  
  functionalGroups.forEach(group => {
    const g = group.toLowerCase();
    if (s1.includes(g) && s2.includes(g)) {
      bonusPoints += 5;
    }
  });
  
  return Math.min(100, Math.round(similarity + bonusPoints));
}

// Enhanced molecular comparison display
function showMolecularComparison(userIngredients, matchedMedicine) {
  const molecularSection = document.getElementById('molecularSection');
  const userSmilesDiv = document.getElementById('userSmiles');
  const matchSmilesDiv = document.getElementById('matchSmiles');
  const similarityDiv = document.getElementById('molecularSimilarity');
  
  if (!molecularSection || !userSmilesDiv || !matchSmilesDiv || !similarityDiv) {
    console.error('Molecular comparison elements not found');
    return;
  }
  
  // Get first ingredient for user drug
  const ingredients = userIngredients.split(';').map(i => i.trim());
  const firstIngredient = ingredients[0];
  
  // Get SMILES for user ingredient and matched medicine
  const userSmiles = SMILES_DATA[firstIngredient] || SMILES_DATA["Paracetamol"];
  const matchSmiles = SMILES_DATA[matchedMedicine] || SMILES_DATA["Paracetamol"];
  
  // Display SMILES strings
  userSmilesDiv.innerHTML = `
    <div style="margin-bottom: 0.5rem;"><strong>${firstIngredient}</strong></div>
    <div>SMILES: ${userSmiles}</div>
  `;
  matchSmilesDiv.innerHTML = `
    <div style="margin-bottom: 0.5rem;"><strong>${matchedMedicine}</strong></div>
    <div>SMILES: ${matchSmiles}</div>
  `;
  
  // Initialize viewers if needed
  if (!userMolViewer || !matchMolViewer) {
    initializeMolecularViewers();
  }
  
  // Get container elements for fallback
  const userContainer = document.getElementById('userMolecule');
  const matchContainer = document.getElementById('matchMolecule');
  
  // Display molecules with fallback support
  displayMolecule(userMolViewer, userSmiles, firstIngredient, userContainer);
  displayMolecule(matchMolViewer, matchSmiles, matchedMedicine, matchContainer);
  
  // Calculate and display similarity
  const similarity = calculateMolecularSimilarity(userSmiles, matchSmiles);
  const similarityColor = similarity > 70 ? '#10b981' : similarity > 40 ? '#f59e0b' : '#ef4444';
  
  similarityDiv.innerHTML = `
    <div style="color: ${similarityColor}; font-size: 1.1rem;">
      Molecular Similarity: ${similarity}%
    </div>
    <div style="font-size: 0.8rem; margin-top: 0.25rem; opacity: 0.9;">
      Comparing: ${firstIngredient} ↔ ${matchedMedicine}
    </div>
    <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.7;">
      Based on structural and functional group analysis
    </div>
  `;
  
  // Show the section with animation
  molecularSection.style.display = 'block';
  molecularSection.style.opacity = '0';
  molecularSection.style.transform = 'translateY(20px)';
  
  setTimeout(() => {
    molecularSection.style.transition = 'all 0.5s ease-out';
    molecularSection.style.opacity = '1';
    molecularSection.style.transform = 'translateY(0)';
  }, 100);
}

const concInput = document.getElementById("concentration");
const mgInput = document.getElementById("dosageMg");
const mlInput = document.getElementById("dosageMl");

function updateFromMg() {
  const conc = parseFloat(concInput.value);
  const mg = parseFloat(mgInput.value);
  if (!isNaN(conc) && conc > 0 && !isNaN(mg)) {
    mlInput.value = (mg / conc).toFixed(2);
  }
}

function updateFromMl() {
  const conc = parseFloat(concInput.value);
  const ml = parseFloat(mlInput.value);
  if (!isNaN(conc) && conc > 0 && !isNaN(ml)) {
    mgInput.value = (ml * conc).toFixed(2);
  }
}

mgInput.addEventListener("input", updateFromMg);
mlInput.addEventListener("input", updateFromMl);
concInput.addEventListener("input", () => {
  if (mgInput.value) updateFromMg();
  else if (mlInput.value) updateFromMl();
});

// Image mapping with better fallback handling
const imageMap = {
  "Paracetamol": "Paracetamol.png",
  "Panadol": "Panadol.png",
  "Panadol Extend": "Panadol_Extend.png",
  "Ibuprofen": "Ibuprofen.png",
  "Clarinase": "Clarinase.png",
  "Cetirizine": "Cetirizine.png",
  "Diphenhydramine": "Diphenhydramine.png",
  "Aspirin": "Aspirin.png",
  "Naproxen": "Naproxen.png",
  "Dextromethorphan_Guaifenesin": "Dextromethorphan_Guaifenesin.png",
  "Pseudoephedrine": "Pseudoephedrine.png",
  "Loratadine": "Loratadine.png",
  "Mefenamic_Acid": "Mefenamic_Acid.png",
  "5-FU + Leucovorin": "5FU_Leucovorin.png",
  "FOLFOX (Oxaliplatin + 5-FU + Leucovorin)": "FOLFOX.png",
  "FOLFIRI (Irinotecan + 5-FU + Leucovorin)": "FOLFIRI.png",
  "Gemcitabine": "Gemcitabine.png",
  "Paclitaxel": "Paclitaxel.png",
  "Doxorubicin": "Doxorubicin.png",
  "Cyclophosphamide": "Cyclophosphamide.png",
  "Methotrexate": "Methotrexate.png",
  "Cisplatin": "Cisplatin.png",
  "Carboplatin": "Carboplatin.png",
  "Imatinib": "Imatinib.png",
  "Trastuzumab": "Trastuzumab.png",
  "Bevacizumab": "Bevacizumab.png",
  "Nivolumab": "Nivolumab.png",
  "Pembrolizumab": "Pembrolizumab.png",
  "Generic": "Generic.png"
};

function imagePathFor(medName) {
  if (!medName) return "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjZjNmNGY2Ii8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNjAiIHI9IjMwIiBmaWxsPSIjOWNhM2FmIi8+Cjx0ZXh0IHg9IjYwIiB5PSI2NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UElMTDwvdGV4dD4KPC9zdmc+";

  // 1) exact map (best)
  if (imageMap[medName]) return `/static/images/${imageMap[medName]}`;

  // 2) try with spaces -> underscores (e.g., "Panadol Extend" -> "Panadol_Extend.png")
  const underscoreName = medName.replace(/\s+/g, "_");
  return `/static/images/${underscoreName}.png`;
}

// Form elements and global variables
const form = document.getElementById('predictForm');
const outputPanel = document.getElementById('outputPanel');
const runMessage = document.getElementById('runMessage');
const effectivenessEl = document.getElementById('effectiveness');
const sideEffectEl = document.getElementById('sideEffect');
const successRateEl = document.getElementById('successRate');
const specificSideEffectsEl = document.getElementById('specificSideEffects');
const matchesList = document.getElementById('matchesList');
const matchMessage = document.getElementById('matchMessage');
const matchedImageArea = document.getElementById('matchedImageArea');
const matchedName = document.getElementById('matchedName');
const comparisonTableBody = document.getElementById('comparisonTableBody');
const badge = document.getElementById('badge');
const clearBtn = document.getElementById('clearBtn');

// Enhanced clear button functionality
clearBtn.addEventListener('click', () => {
    form.reset();
    outputPanel.style.display = 'none';
    document.getElementById('molecularSection').style.display = 'none';
    runMessage.textContent = '';
    matchesList.innerHTML = '';
    matchMessage.textContent = '';
    matchedImageArea.innerHTML = '';
    matchedName.textContent = '';
    comparisonTableBody.innerHTML = '';
    
    // Clean up chart instances
    if (radarChartInstance) { 
      radarChartInstance.destroy(); 
      radarChartInstance = null; 
    }
    if (ethnicityChartInstance) { 
      ethnicityChartInstance.destroy(); 
      ethnicityChartInstance = null; 
    }
    if (rollerChartInstance) { 
      rollerChartInstance.destroy(); 
      rollerChartInstance = null; 
    }
    
    // Clean up molecular viewers
    if (userMolViewer) { 
      userMolViewer.clear(); 
      userMolViewer = null;
    }
    if (matchMolViewer) { 
      matchMolViewer.clear(); 
      matchMolViewer = null;
    }
});

// Auto-set Line of Treatment based on disease
const targetSymptomEl = document.getElementById('targetSymptom');
const lineOfTreatmentEl = document.getElementById('lineOfTreatment');

const autoTreatmentMap = {
  // Oncology
  "Breast Cancer (HER2+)": "Targeted",
  "Breast Cancer": "First-Line",
  "Colon Cancer": "First-Line",
  "Lung Cancer": "First-Line",
  "Leukemia": "Targeted",
  "Lymphoma": "First-Line",
  "Pancreatic Cancer": "Second-Line",
  "Melanoma": "Targeted",
  // General Primary Care
  "Fever": "General",
  "Cough": "General",
  "Headache": "General",
  "Flu": "General",
  "Sore Throat": "General"
};

targetSymptomEl.addEventListener('change', () => {
  const selected = targetSymptomEl.value;
  if (autoTreatmentMap[selected]) {
    lineOfTreatmentEl.value = autoTreatmentMap[selected];
  } else {
    lineOfTreatmentEl.value = "General";
  }
});

function generateSimulationCurve(drug) {
  const months = [0, 1, 2, 3, 4, 5, 6];
  const values = [];

  const successRate = Number(drug.success_rate) || 0;
  const effectiveness = Number(drug.effectiveness) || 0;
  const risk = (drug.side_effect_risk || "").toLowerCase();

  months.forEach(m => {
    let heal = successRate * (1 - Math.exp(-(effectiveness / 100) * m));

    // risk adjustments
    if (risk === "medium" && m === 3) heal -= 5;
    if (risk === "high" && (m === 2 || m === 5)) heal -= 10;

    values.push(Math.max(0, Math.min(100, Math.round(heal))));
  });

  return { months, values };
}

function generateHybridCurve(drug, aiAdjustments) {
    const months = [0,1,2,3,4,5,6];
    const values = [];
    
    const successRate = Number(drug.success_rate) || 0;
    const effectiveness = Number(drug.effectiveness) || 0;
    const risk = (drug.side_effect_risk || "").toLowerCase();

    months.forEach((m, idx) => {
        // Base math curve
        let heal = successRate * (1 - Math.exp(-(effectiveness/100)*m));

        // Risk adjustments
        if(risk === "medium" && m===3) heal -= 5;
        if(risk === "high" && (m===2 || m===5)) heal -= 10;

        // AI adjustment multiplier
        const aiFactor = aiAdjustments && aiAdjustments[idx] ? aiAdjustments[idx] : 1;
        heal = heal * aiFactor;

        values.push(Math.max(0, Math.min(100, Math.round(heal))));
    });

    return { months, values };
}

function addWiggle(values, magnitude=3) {
    return values.map(v => {
        const delta = (Math.random() * 2 - 1) * magnitude;
        return Math.max(0, Math.min(100, Math.round(v + delta)));
    });
}

// Enhanced form submission handler with better error handling
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Show loading state
  runMessage.textContent = 'Running simulation...';
  runMessage.className = 'text-sm text-blue-200 mt-1';
  outputPanel.style.display = 'none';
  document.getElementById('molecularSection').style.display = 'none';
  
  // Reset displays
  matchesList.innerHTML = '';
  matchMessage.textContent = '';
  matchedImageArea.innerHTML = '';
  matchedName.textContent = '';
  comparisonTableBody.innerHTML = '';
  
  // Clean up existing charts
  if (radarChartInstance) { radarChartInstance.destroy(); radarChartInstance = null; }
  if (ethnicityChartInstance) { ethnicityChartInstance.destroy(); ethnicityChartInstance = null; }
  if (rollerChartInstance) { rollerChartInstance.destroy(); rollerChartInstance = null; }

  // Collect form data
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  const selectedCondition = formData.get("health_condition");
  data.health_conditions = selectedCondition && selectedCondition !== "none" 
      ? [selectedCondition] 
      : [];

  try {
    // Mock API call for demonstration (replace with actual endpoint)
    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate API delay
    
    // Mock response data (replace with actual API response)
    const result = {
      predicted_effectiveness: Math.floor(Math.random() * 30) + 70, // 70-100%
      predicted_side_effect_risk: ["Low", "Medium", "High"][Math.floor(Math.random() * 3)],
      predicted_success_rate: Math.floor(Math.random() * 25) + 75, // 75-100%
      predicted_specific_side_effects: "Mild drowsiness; Possible nausea; Rare skin rash",
      best_match: {
        medicine_name: data.target_symptom === "Headache" ? "Paracetamol" : "Ibuprofen",
        percent: Math.floor(Math.random() * 20) + 80, // 80-100%
        target_symptom: data.target_symptom,
        ingredients_active: ["Paracetamol", "Caffeine"],
        ingredients_inactive: ["Starch", "Lactose"],
        known_side_effects: "Nausea; Dizziness; Stomach upset",
        effectiveness: 85,
        success_rate: 90,
        side_effect_risk: "Low",
        dosage_mg: 500
      },
      strong_match: true,
      top_matches: [
        {
          medicine_name: data.target_symptom === "Headache" ? "Paracetamol" : "Ibuprofen",
          percent: 85,
          target_symptom: data.target_symptom,
          ingredients_active: ["Paracetamol"],
          known_side_effects: "Mild stomach upset"
        },
        {
          medicine_name: "Aspirin",
          percent: 72,
          target_symptom: data.target_symptom,
          ingredients_active: ["Acetylsalicylic acid"],
          known_side_effects: "Stomach irritation; Blood thinning"
        }
      ],
      new_drug_explanations: [
        `Effectiveness predicted at ${Math.floor(Math.random() * 30) + 70}% based on ingredient analysis`,
        `Risk assessment considers patient demographics and health conditions`,
        `Success rate optimized for ${data.race} population based on pharmacogenomic data`
      ],
      ethnicity_scores: {
        new_drug: {
          "Malay": 88,
          "Chinese": 82,
          "Indian": 85,
          "Indigenous": 79
        },
        known_medicine: {
          "Malay": 85,
          "Chinese": 87,
          "Indian": 83,
          "Indigenous": 81
        }
      },
      ai_curve_new_drug: [1, 1.1, 1.05, 0.95, 1.0, 1.08, 1.12],
      ai_curve_best_match: [1, 1.0, 0.98, 1.02, 1.05, 1.03, 1.0]
    };
    
    runMessage.textContent = '';
    runMessage.className = 'text-sm text-gray-200 mt-1';
    outputPanel.style.display = 'block';

    // Display basic predictions
    effectivenessEl.textContent = (result.predicted_effectiveness ?? '-') + '%';
    sideEffectEl.textContent = result.predicted_side_effect_risk ?? '-';
    successRateEl.textContent = (result.predicted_success_rate ?? '-') + '%';

    // Show explanations
    const reasonsBox = document.getElementById("newDrugReasons");
    reasonsBox.innerHTML = "";

    if (result.new_drug_note) {
      const warn = document.createElement("div");
      warn.className = "bg-red-100 text-red-800 rounded px-2 py-1 text-sm";
      warn.textContent = result.new_drug_note;
      reasonsBox.appendChild(warn);
    }

    if (result.new_drug_explanations) {
      result.new_drug_explanations.forEach(msg => {
        if (msg && msg.trim() !== "") {
          const div = document.createElement("div");
          div.textContent = "• " + msg;
          reasonsBox.appendChild(div);
        }
      });
    }

    // Show best match info
    const matchBox = document.getElementById("bestMatchBox");
    if (matchBox && result.best_match) {
      matchBox.innerHTML = `
        <h3 class="text-lg font-semibold mb-1">Best Match</h3>
        <p><b>Medicine:</b> ${result.best_match.medicine_name}</p>
        <p><b>Similarity Score:</b> ${result.best_match.percent}%</p>
        <div class="mt-2 text-xs text-gray-600">
          This match was found based on ingredient similarity, target symptoms, and efficacy profiles.
        </div>
      `;
    }

    // Update badge and match message
    if (result.strong_match && result.best_match) {
      badge.textContent = `Strong match: ${result.best_match.medicine_name} (${result.best_match.percent}%)`;
      badge.className = 'text-sm text-green-200 font-medium bg-green-800 px-3 py-1 rounded-full';
      matchMessage.textContent = `Best match: ${result.best_match.medicine_name} — ${result.best_match.percent}% similarity.`;
    } else {
      badge.textContent = 'No strong match';
      badge.className = 'text-sm text-yellow-200 font-medium bg-yellow-800 px-3 py-1 rounded-full';
      matchMessage.textContent = 'No strong match found in our database.';
    }

    specificSideEffectsEl.innerHTML = formatSideEffects(result.predicted_specific_side_effects) || '-';

    // Display top matches
    (result.top_matches || []).forEach(m => {
      const card = document.createElement('div');
      card.innerHTML = `
        <div class="text-sm font-semibold">
          ${m.medicine_name} <span class="text-xs text-gray-500">(${m.target_symptom})</span>
        </div>
        <div class="text-xs text-gray-600">Match: <strong>${m.percent}%</strong></div>
        <div class="text-xs text-gray-600"><strong>Active:</strong> ${(m.ingredients_active || []).join(', ') || '-'}</div>
        <div class="text-xs text-gray-600"><strong>Inactive:</strong> ${(m.ingredients_inactive || []).join(', ') || '-'}</div>
        <div class="text-xs text-gray-600"><strong>Known side effects:</strong> ${formatSideEffects(m.known_side_effects)}</div>
      `;
      matchesList.appendChild(card);
    });

    // Show matched image and molecular comparison
    const best = result.best_match || (result.top_matches && result.top_matches[0]);
    if (best) {
      const img = document.createElement('img');
      img.alt = best.medicine_name;
      img.src = imagePathFor(best.medicine_name);
      img.onerror = () => {
        img.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjZjNmNGY2Ii8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNjAiIHI9IjMwIiBmaWxsPSIjOWNhM2FmIi8+Cjx0ZXh0IHg9IjYwIiB5PSI2NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UElMTDwvdGV4dD4KPC9zdmc+";
      };
      matchedImageArea.appendChild(img);
      matchedName.textContent = best.medicine_name;

      // Show molecular comparison
      showMolecularComparison(data.ingredients, best.medicine_name);

      // Build comparison table
      const newDrug = {
        drug_name: data.drug_name,
        ingredients: data.ingredients,
        dosage_mg: data.dosage_mg || data.dosageMg || '-',  
        line_of_treatment: data.line_of_treatment || data.lineOfTreatment || '-', 
        target_symptom: data.target_symptom,
        health_condition: data.health_conditions || [],
        effectiveness: result.predicted_effectiveness,
        success_rate: result.predicted_success_rate,
        side_effect_risk: result.predicted_side_effect_risk,
        predicted_specific_side_effects: result.predicted_specific_side_effects || []
      };

      const formatSideEffectsTable = (effects) => {
        if (!effects || effects === '-') return '-';
        if (Array.isArray(effects)) return effects.join(', ');
        return effects.split(/[,;]+/).map(e => e.trim()).filter(Boolean).join(', ');
      };

      comparisonTableBody.innerHTML = '';

      const rows = [
        ['Drug Name', newDrug.drug_name || '-', best.medicine_name || '-'],
        ['Target Symptom', newDrug.target_symptom || '-', best.target_symptom || '-'],
        ['Line of Treatment', newDrug.line_of_treatment || '-', best.line_of_treatment || '-'],
        ['Health Condition', (newDrug.health_condition || []).join(', ') || '-', best.health_condition || '-'],
        ['Ingredients',
          newDrug.ingredients || '-',
          (((best.ingredients_active || []).join(', ')) +
          (best.ingredients_inactive?.length ? ' (inactive: ' + best.ingredients_inactive.join(', ') + ')' : '')
          ) || '-'
        ],
        ['Dosage (mg)', newDrug.dosage_mg || '-', best.dosage_mg || '-'],
        ['Effectiveness', `${newDrug.effectiveness}%`, best.effectiveness ? best.effectiveness + '%' : '-'],
        ['Success Rate', `${newDrug.success_rate}%`, best.success_rate ? best.success_rate + '%' : '-'],
        ['Side Effect Risk', newDrug.side_effect_risk || '-', best.side_effect_risk || '-'],
        ['Likely Side Effects',
          formatSideEffectsTable(newDrug.predicted_specific_side_effects),
          formatSideEffectsTable(best?.known_side_effects || '-')
        ]
      ];

      rows.forEach(([label, a, b]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 font-semibold">${label}</td>
          <td class="px-3 py-2">${a}</td>
          <td class="px-3 py-2">${b}</td>
        `;
        comparisonTableBody.appendChild(tr);
      });

      // Create radar chart
      const safetyMap = { 'Low': 100, 'Medium': 50, 'High': 10 };
      const ndEffect = Number(newDrug.effectiveness) || 0;
      const ndSuccess = Number(newDrug.success_rate) || 0;
      const ndSafety = safetyMap[newDrug.side_effect_risk] ?? 0;
      const ndDosageScaled = Math.min(100, Number(newDrug.dosage_mg) || 0) / 10;
      const ndIngCount = (newDrug.ingredients || '').split(';').filter(x => x.trim()).length * 10;

      const knEffect = Number(best.effectiveness) || 0;
      const knSuccess = Number(best.success_rate) || 0;
      const knSafety = safetyMap[best.side_effect_risk] ?? 0;
      const knDosageScaled = Math.min(100, Number(best.dosage_mg) || 0) / 10;
      const knIngCount = (best.ingredients_active || []).length * 10;

      const ctx = document.getElementById('radarChart').getContext('2d');
      if (radarChartInstance) radarChartInstance.destroy();
      radarChartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Effectiveness', 'Success', 'Safety', 'Dosage', '#Ingredients'],
          datasets: [
            {
              label: 'New Drug',
              data: [ndEffect, ndSuccess, ndSafety, ndDosageScaled, ndIngCount],
              backgroundColor: 'rgba(79,70,229,0.2)',
              borderColor: '#4f46e5',
              pointBackgroundColor: '#4f46e5',
              fill: true,
              borderWidth: 2
            },
            {
              label: 'Known Medicine',
              data: [knEffect, knSuccess, knSafety, knDosageScaled, knIngCount],
              backgroundColor: 'rgba(16,185,129,0.2)',
              borderColor: '#10b981',
              pointBackgroundColor: '#10b981',
              fill: true,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top', labels: { color: 'white' } } },
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 100,
              ticks: { stepSize: 20, color: '#6b7280', backdropColor: 'transparent' },
              angleLines: { color: '#d1d5db' },
              grid: { color: '#e5e7eb' },
              pointLabels: { color: 'white', font: { size: 12 } }
            }
          }
        }
      });

      // Create ethnicity radar chart
      const ctx2 = document.getElementById('ethnicityRadarChart').getContext('2d');
      const labels = ["Malay", "Chinese", "Indian", "Indigenous"];
      const newDrugData = labels.map(l => result.ethnicity_scores?.new_drug?.[l] ?? 0);
      const knownMedData = labels.map(l => result.ethnicity_scores?.known_medicine?.[l] ?? 0);
      const selectedEthnicity = data.race || '';

      if (ethnicityChartInstance) ethnicityChartInstance.destroy();

      ethnicityChartInstance = new Chart(ctx2, {
          type: 'radar',
          data: {
              labels: labels,
              datasets: [
                  {
                      label: "New Drug",
                      data: newDrugData,
                      borderColor: "#4f46e5",
                      backgroundColor: "rgba(79,70,229,0.2)",
                      pointBackgroundColor: newDrugData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#4f46e5'
                      ),
                      pointBorderColor: newDrugData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#4f46e5'
                      )
                  },
                  {
                      label: "Known Medicine",
                      data: knownMedData,
                      borderColor: "#10b981",
                      backgroundColor: "rgba(16,185,129,0.2)",
                      pointBackgroundColor: knownMedData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#10b981'
                      ),
                      pointBorderColor: knownMedData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#10b981'
                      )
                  }
              ]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: { labels: { color: 'white' } },
                  title: { display: true, text: 'Drug Performance by Ethnicity', color: 'white' }
              },
              scales: {
                  r: {
                      suggestedMin: 0,
                      suggestedMax: 100,
                      ticks: { stepSize: 20, color: 'white' },
                      angleLines: { color: 'rgba(255,255,255,0.2)' },
                      grid: { color: 'rgba(255,255,255,0.1)' },
                      pointLabels: { color: 'white', font: { size: 12 } }
                  }
              }
          }
      });

      // Create patient recovery simulation chart
      const ndAiAdjustments = result.ai_curve_new_drug || [1,1,1,1,1,1,1];
      const bmAiAdjustments = result.ai_curve_best_match || [1,1,1,1,1,1,1];

      const ndCurve = generateHybridCurve(newDrug, ndAiAdjustments);
      const bmCurve = generateHybridCurve(best, bmAiAdjustments);

      // Add realistic fluctuations
      ndCurve.values = addWiggle(ndCurve.values, 3);
      bmCurve.values = addWiggle(bmCurve.values, 3);

      const ctxRoller = document.getElementById('rollerChart').getContext('2d');

      if (rollerChartInstance) {
        rollerChartInstance.destroy();
      }

      rollerChartInstance = new Chart(ctxRoller, {
        type: 'line',
        data: {
          labels: ndCurve.months.map(m => `Month ${m}`),
          datasets: [
            {
              label: newDrug.drug_name || "New Drug",
              data: ndCurve.values,
              borderColor: "rgba(75,192,192,1)",
              backgroundColor: "rgba(75,192,192,0.3)",
              tension: 0.4,
              fill: true
            },
            {
              label: best.medicine_name || "Best Match",
              data: bmCurve.values,
              borderColor: "rgba(255,99,132,1)",
              backgroundColor: "rgba(255,99,132,0.3)",
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "Predicted Patient Healing Over 6 Months",
              color: 'white',
              font: { size: 16 }
            },
            legend: {
              labels: { color: 'white' }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Patient Cure/Healing (%)',
                color: 'white'
              },
              ticks: { color: 'white' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            x: {
              title: {
                display: true,
                text: 'Months',
                color: 'white'
              },
              ticks: { color: 'white' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });  
    }

  } catch (err) {
    console.error('Simulation error:', err);
    runMessage.textContent = 'Simulation failed. Please check your inputs and try again.';
    runMessage.className = 'text-sm text-red-300 mt-1';
  }
});

// Enhanced PDF Download functionality
document.getElementById('downloadPDF').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const section = document.getElementById('outputPanel');
  const btn = document.getElementById('downloadPDF');
  
  if (!section) {
    alert('No data to download. Please run a simulation first.');
    return;
  }
  
  btn.textContent = 'Generating PDF...';
  btn.disabled = true;
  
  try {
    // Temporarily hide the download button for the screenshot
    btn.style.display = 'none';
    
    const canvas = await html2canvas(section, { 
      scale: 2,
      logging: false,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff'
    });
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    let heightLeft = imgHeight;
    let position = 10;
    
    // Add title page
    pdf.setFontSize(20);
    pdf.text('PharmaSim AI - Drug Simulation Report', 20, 30);
    pdf.setFontSize(12);
    pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);
    pdf.text(`Time: ${new Date().toLocaleTimeString()}`, 20, 55);
    
    // Add main content
    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
    heightLeft -= pageHeight - 20;
    
    while (heightLeft > 0) {
      position = heightLeft - imgHeight + 10;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight - 20;
    }
    
    pdf.save(`pharmasim_report_${Date.now()}.pdf`);
    
  } catch (error) {
    console.error('PDF generation failed:', error);
    alert('Failed to generate PDF. Please try again.');
  } finally {
    btn.style.display = 'block';
    btn.textContent = 'Download as PDF';
    btn.disabled = false;
  }
});

// Initialize molecular viewers on page load
document.addEventListener('DOMContentLoaded', () => {
  // Check if 3Dmol is loaded
  if (typeof $3Dmol === 'undefined') {
    console.warn('3Dmol.js library not loaded properly');
  } else {
    console.log('3Dmol.js library loaded successfully');
  }
});

// Add some helpful tooltips and UI enhancements
document.querySelectorAll('input[required], select[required]').forEach(element => {
  element.addEventListener('invalid', (e) => {
    e.target.setCustomValidity('This field is required');
  });
  
  element.addEventListener('input', (e) => {
    e.target.setCustomValidity('');
  });
});

// Add form validation feedback
form.addEventListener('input', (e) => {
  const formData = new FormData(form);
  const requiredFields = ['drug_name', 'race', 'gender', 'age', 'target_symptom', 'ingredients'];
  const filledFields = requiredFields.filter(field => formData.get(field));
  
  if (filledFields.length === requiredFields.length) {
    document.querySelector('button[type="submit"]').style.backgroundColor = '#10b981';
  } else {
    document.querySelector('button[type="submit"]').style.backgroundColor = '#4f46e5';
  }
});
</script>
</body>
</html>