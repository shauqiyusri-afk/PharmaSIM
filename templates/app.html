<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PharmaSim AI â€” Enhanced Simulation with Molecules</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- 3Dmol.js for molecule rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
<style>
/* ------------------------- BODY & BACKGROUND ------------------------- */
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: start;
  padding-top: 2rem;
  background-color: black;
  overflow-x: hidden;
}
.bg-image {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -3;
}
.overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.35);
  z-index: -2;
}

/* ------------------------- CARD LAYOUT ------------------------- */
.card {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  width: 100%;
  max-width: 1400px;
  overflow: hidden;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  padding: 2rem;
  animation: fadeIn 0.8s ease-out;
  border: 1px solid rgba(255, 255, 255, 0.3);
}
@keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

/* ------------------------- FORM ------------------------- */
form label {
  font-weight: 600;
  margin-bottom: 0.25rem;
  display: block;
  color: white;
}
form input, form select {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  margin-bottom: 1rem;
  transition: all 0.2s;
}
form input:focus, form select:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 2px rgba(79,70,229,0.2);
}

/* ------------------------- BUTTONS ------------------------- */
.btn-main {
  padding: 0.75rem 1.5rem;
  border-radius: 9999px;
  font-weight: bold;
  font-size: 1.1rem;
  margin: 0.25rem 0;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.25s ease;
}
.btn-login { background-color:#4f46e5; color:white; }
.btn-login:hover { background-color:white; color:#4f46e5; border-color:#4f46e5; transform:translateY(-2px) scale(1.05); }
.btn-register { background-color:#10b981; color:white; }
.btn-register:hover { background-color:white; color:#10b981; border-color:#10b981; transform:translateY(-2px) scale(1.05); }
.btn-action { background-color:#f59e0b; color:white; }
.btn-action:hover { background-color:#b45309; }

/* ------------------------- OUTPUT PANEL ------------------------- */
#outputPanel { display:none; margin-top:1rem; color:#1f2937; }

/* ------------------------- TOP MATCHES ------------------------- */
#matchesList > div {
  background: rgba(255,255,255,0.75);
  padding: 0.75rem;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.1);
  transition: transform 0.25s, box-shadow 0.25s;
}
#matchesList > div:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* ------------------------- MOLECULE VIEWER STYLES ------------------------- */
.molecule-section {
  margin-top: 2rem;
  background: rgba(255,255,255,0.9);
  border-radius: 16px;
  padding: 1.5rem;
}

.molecule-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-top: 1rem;
}

.molecule-viewer {
  background: white;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  overflow: hidden;
}

.molecule-title {
  background: #f3f4f6;
  padding: 0.75rem;
  font-weight: 600;
  color: #374151;
  border-bottom: 1px solid #d1d5db;
  text-align: center;
}

.molecule-canvas {
  width: 100%;
  height: 250px;
  display: block;
}

.molecule-info {
  padding: 1rem;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.molecule-smiles {
  font-family: 'Courier New', monospace;
  font-size: 0.8rem;
  background: white;
  padding: 0.5rem;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  word-break: break-all;
  color: #1f2937;
}

.molecule-controls {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
  flex-wrap: wrap;
}

.control-btn {
  padding: 0.25rem 0.75rem;
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: background-color 0.2s;
}

.control-btn:hover {
  background: #3730a3;
}

/* ------------------------- TABLE AND CHARTS LAYOUT ------------------------- */
.table-charts-container {
  display: flex;
  gap: 2rem;
  margin-top: 1.5rem;
  align-items: flex-start;
}

.table-section {
  flex: 1;
  min-width: 0;
}

.charts-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* ------------------------- TABLE ------------------------- */
table { 
  width: 100%; 
  border-collapse: collapse; 
  background: white; 
  border-radius: 12px; 
  overflow: hidden; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
}
th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
th { background: #e0e7ff; font-weight: 600; }
tbody tr:nth-child(even) { background: #f9fafb; }

/* ------------------------- RADAR CHART ------------------------- */
.radar-wrap { 
  position: relative; 
  height: 380px; 
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.radar-title {
  color: white;
  font-size: 1.1rem;
  font-weight: 600;
  text-align: center;
  margin-bottom: 1rem;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* ------------------------- MATCH IMAGE ------------------------- */
#matchedImageArea img { 
  border-radius: 50%; 
  width: 120px; 
  height: 120px; 
  object-fit: cover; 
  margin-bottom: 0.5rem; 
  transition: transform 0.3s; 
}
#matchedImageArea img:hover { transform: scale(1.1); }
#matchedImageArea {
  display: flex;            
  justify-content: center;  
  align-items: center;      
  margin-bottom: 0.5rem;    
}

/* ------------------------- RESPONSIVE ------------------------- */
@media(max-width:1024px){ 
  .card { grid-template-columns: 1fr; }
  .table-charts-container { flex-direction: column; }
  .charts-section { flex-direction: row; }
  .molecule-container { grid-template-columns: 1fr; }
}
@media(max-width:768px){ 
  .charts-section { flex-direction: column; }
  .molecule-container { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- BACKGROUND -->
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -3;"></div>
<div class="overlay"></div>

<!-- MAIN CARD -->
<div class="card">

  <!-- LEFT: FORM -->
  <div>
    <h1 class="text-2xl font-bold text-indigo-600 mb-4">Simulate New Drug</h1>
    <form id="predictForm" class="space-y-2">
      <div>
        <label>Drug Name</label>
        <input name="drug_name" required placeholder="e.g. MyPainRelief">
      </div>
      
      <!-- Add SMILES input field -->
      <div>
        <label>SMILES Structure <span class="text-xs text-gray-400">(optional)</span></label>
        <input name="smiles" placeholder="e.g. CC(=O)NC1=CC=C(O)C=C1" title="Enter SMILES string for molecular structure">
      </div>
      
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label>Race</label>
          <select name="race" required>
            <option value="">--Select--</option>
            <option>Malay</option>
            <option>Chinese</option>
            <option>Indian</option>
            <option>Indigenous</option>
          </select>
        </div>
        <div>
          <label>Gender</label>
          <select name="gender" required>
            <option value="">--Select--</option>
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label>Age</label>
          <input name="age" type="number" min="0" required>
        </div>
        <div>
          <label class="block mb-2">Concentration (mg/mL)</label>
          <input name="concentration" id="concentration" type="number" step="any" min="0" placeholder="e.g. 5"
            class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300">
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block mb-2">Dosage (mg)</label>
          <input name="dosage_mg" id="dosageMg" type="number" step="any" min="0" placeholder="e.g. 500" 
            class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300">
        </div>
        <div>
          <label class="block mb-2">Dosage (mL)</label>
          <input name="dosage_ml" id="dosageMl" type="number" step="any" min="0" placeholder="auto-calculated" 
            class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300">
        </div>
      </div>
      
      <div>
        <label>Target Symptom / Disease</label>
        <select name="target_symptom" id="targetSymptom" required>
          <option value="">--Select--</option>
          <!-- General conditions -->
          <option>Fever</option>
          <option>Cough</option>
          <option>Headache</option>
          <option>Flu</option>
          <option>Sore Throat</option>
          
          <!-- Oncology conditions -->
          <option>Colon Cancer</option>
          <option>Breast Cancer</option>
          <option>Breast Cancer (HER2+)</option>
          <option>Lung Cancer</option>
          <option>Leukemia</option>
          <option>Lymphoma</option>
          <option>Pancreatic Cancer</option>
          <option>Melanoma</option>
        </select>
      </div>

      <div>
        <label>Line of Treatment</label>
        <select name="line_of_treatment" id="lineOfTreatment" required>
          <option value="General">General</option>
          <option value="First-Line">First-Line</option>
          <option value="Second-Line">Second-Line</option>
          <option value="Targeted">Targeted</option>
        </select>
      </div>

      <!-- HEALTH CONDITION DROPDOWN -->
      <div class="mt-4">
        <label class="block mb-2 text-white">Health Condition</label>
        <select name="health_condition" class="w-full p-2 rounded-lg border border-gray-300 focus:ring focus:ring-blue-300 text-black">
          <option value="">-- Select --</option>
          <option value="none">None</option>
          <option value="liver_disease">Liver Disease</option>
          <option value="kidney_disease">Kidney Disease</option>
          <option value="asthma">Asthma</option>
          <option value="heart_disease">Heart Disease</option>
          <option value="hypertension">Hypertension</option>
          <option value="pregnancy">Pregnancy</option>
          <option value="glaucoma">Glaucoma</option>
          <option value="elderly">Elderly (Sedation Risk)</option>
        </select>
      </div>
      
      <div>
        <label>Ingredients <span class="text-xs text-gray-500">(separate with ;)</span></label>
        <input name="ingredients" placeholder="e.g. Paracetamol;Caffeine" required>
      </div>
      
      <div class="flex flex-wrap gap-2 mt-2">
        <button type="submit" class="btn-main btn-login flex-1">Simulate</button>
        <button type="button" id="clearBtn" class="btn-main btn-register">Clear</button>
      </div>
      <p id="runMessage" class="text-sm text-gray-200 mt-1"></p>
    </form>
  </div>

  <!-- RIGHT: OUTPUT PANEL -->
  <div id="outputPanel" class="space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-semibold text-green-700">Simulation Result</h2>
      <div id="badge" class="text-sm text-white font-medium"></div>
    </div>

    <div class="flex gap-4 flex-wrap">
      <div>
        <p class="text-sm text-white">Effectiveness</p>
        <div id="effectiveness" class="text-lg font-bold text-green-800">â€”</div>
      </div>
      <div>
        <p class="text-sm text-white">Side Effect Risk</p>
        <div id="sideEffect" class="text-lg font-semibold text-yellow-700">â€”</div>
      </div>
      <div>
        <p class="text-sm text-white">Success Rate</p>
        <div id="successRate" class="text-lg font-semibold text-blue-700">â€”</div>
      </div>
    </div>

    <div id="bestMatchBox" class="mt-4 p-3 border rounded bg-gray-50 text-sm"></div>

    <div class="mt-2">
        <p class="text-sm text-white font-semibold">Why These Predictions?</p>
        <div id="newDrugReasons" class="text-sm text-gray-200 space-y-1"></div>
    </div>

    <div>
      <p class="text-sm text-white">Likely Side Effects</p>
      <div id="specificSideEffects" class="text-sm text-white">â€”</div>
    </div>

    <div id="matchInfo" class="p-3 rounded border border-gray-200 bg-gray-50">
      <div id="matchMessage" class="text-black font-bold mt-4"></div>
    </div>

    <div>
      <h3 class="text-md font-medium text-white mb-2">Top Matches</h3>
      <div id="matchesList" class="space-y-2"></div>
    </div>

    <div class="text-center">
      <div id="matchedImageArea" class="mb-2"></div>
      <div id="matchedName" class="text-sm font-semibold text-white"></div>
    </div>

    <!-- MOLECULAR STRUCTURE COMPARISON SECTION -->
    <div id="moleculeSection" class="molecule-section" style="display:none;">
      <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Molecular Structure Comparison</h3>
      <div class="molecule-container">
        <!-- New Drug Molecule -->
        <div class="molecule-viewer">
          <div class="molecule-title">Your New Drug</div>
          <div id="newDrugViewer" class="molecule-canvas"></div>
          <div class="molecule-info">
            <div class="text-sm font-medium text-gray-600 mb-2">SMILES:</div>
            <div id="newDrugSmiles" class="molecule-smiles">-</div>
            <div class="molecule-controls">
              <button class="control-btn" onclick="resetNewDrugView()">Reset View</button>
              <button class="control-btn" onclick="toggleNewDrugStyle()">Toggle Style</button>
            </div>
          </div>
        </div>

        <!-- Known Medicine Molecule -->
        <div class="molecule-viewer">
          <div class="molecule-title" id="knownMedTitle">Known Medicine</div>
          <div id="knownMedViewer" class="molecule-canvas"></div>
          <div class="molecule-info">
            <div class="text-sm font-medium text-gray-600 mb-2">SMILES:</div>
            <div id="knownMedSmiles" class="molecule-smiles">-</div>
            <div class="molecule-controls">
              <button class="control-btn" onclick="resetKnownMedView()">Reset View</button>
              <button class="control-btn" onclick="toggleKnownMedStyle()">Toggle Style</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TABLE AND CHARTS SIDE BY SIDE -->
    <div class="table-charts-container">
      <!-- TABLE SECTION -->
      <div class="table-section">
        <div class="overflow-x-auto">
          <table class="table-auto w-full text-sm text-left text-gray-600">
            <thead class="bg-blue-50">
              <tr>
                <th class="px-3 py-2">Attribute</th>
                <th class="px-3 py-2">New Drug</th>
                <th class="px-3 py-2">Known Medicine</th>
              </tr>
            </thead>
            <tbody id="comparisonTableBody" class="align-top"></tbody>
          </table>
        </div>
      </div>

      <!-- CHARTS SECTION -->
      <div class="charts-section">
        <div class="radar-wrap">
          <div class="radar-title">Drug Comparison</div>
          <canvas id="radarChart"></canvas>
        </div>

        <div class="radar-wrap">
          <div class="radar-title">Ethnicity Comparison</div>
          <canvas id="ethnicityRadarChart"></canvas>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-bold text-center">Patient Recovery Simulation (6 Months)</h2>
      <canvas id="rollerChart" width="400" height="200"></canvas>
    </div>

    <div class="mt-4 text-center">
      <button id="downloadPDF" class="btn-action">Download as PDF</button>
    </div>
  </div>
</div>

<script>
// Global variables for 3Dmol viewers and other charts
let newDrugViewer = null;
let knownMedViewer = null;
let radarChartInstance = null;
let ethnicityChartInstance = null;
let rollerChartInstance = null;
let newDrugStyle = 'stick';
let knownMedStyle = 'stick';

// SMILES database (from your JSON)
const smilesDatabase = {
  "Paracetamol": "CC(=O)NC1=CC=C(O)C=C1",
  "Ibuprofen": "CC(C)CC1=CC=C(C=C1)C(C)C(=O)O",
  "Clarinase": "CC1=CC=C(C=C1)C(CO)NC(C)C",
  "Cetirizine": "C1=CC(=CC=C1CCN2CCN(CC2)CCOCCO)Cl",
  "Diphenhydramine": "CN(C)CCOC(C1=CC=CC=C1)C2=CC=CC=C2",
  "5-FU": "C1=CN=C(C(=O)N1)F",
  "Leucovorin": "CC1=C(C(=O)N(C(=O)C1C(=O)O)C)N",
  "Oxaliplatin": "CC(=O)NC1=CC=C(O)C=C1",
  "Irinotecan": "CC1=CC2=C(C=C1)N(C(=O)C2O)C",
  "Gemcitabine": "C1=CN(C(=O)N=C1N)C2C(C(C(O2)CO)O)F",
  "Paclitaxel": "CC1=CC2=C(C=C1)OC3=C(C(=C(C(=C3O2)C(=O)OC)C)C)C",
  "Doxorubicin": "CC1=CC(=CC(=C1)O)C(=O)C2=CC=CC=C2",
  "Cyclophosphamide": "C1CN2CCOCC2O1",
  "Methotrexate": "CC1=CC(=CC=C1)NC2=NC(=NC(=N2)N)N",
  "Cisplatin": "CC(=O)NC1=CC=C(O)C=C1",
  "Carboplatin": "CC(=O)NC1=CC=C(O)C=C1",
  "Imatinib": "CC1=CC(=C(C=C1)NC(=O)C2=CC=CC=N2)NC3=CC=CC=C3",
  "Trastuzumab": "CC(=O)NC1=CC=C(O)C=C1",
  "Bevacizumab": "CC(=O)NC1=CC=C(O)C=C1",
  "Nivolumab": "CC(=O)NC1=CC=C(O)C=C1"
};

// Initialize 3Dmol viewers
function initializeMoleculeViewers() {
  const newDrugElement = document.getElementById('newDrugViewer');
  const knownMedElement = document.getElementById('knownMedViewer');
  
  if (newDrugElement && knownMedElement) {
    newDrugViewer = $3Dmol.createViewer(newDrugElement, {
      defaultcolors: $3Dmol.elementColors.Jmol
    });
    
    knownMedViewer = $3Dmol.createViewer(knownMedElement, {
      defaultcolors: $3Dmol.elementColors.Jmol
    });
  }
}

// Convert SMILES to SDF format (simplified approach)
async function smilesToSDF(smiles) {
  // For a real implementation, you'd want to use a service like:
  // - PubChem REST API
  // - ChemSpider API
  // - Or a local chemistry toolkit
  
  // For now, we'll create a simple mock SDF structure
  // This is a placeholder - in production you'd convert properly
  
  const mockSDF = `
  Mrv2014 01010000002D          

  0  0  0     0  0            999 V3000
M  V30 BEGIN CTAB
M  V30 COUNTS 0 0 0 0 0
M  V30 END CTAB
M  END
`;
  
  return mockSDF;
}

// Render molecule in 3Dmol viewer
async function renderMolecule(viewer, smiles, name) {
  if (!viewer || !smiles) return;
  
  try {
    viewer.clear();
    
    // Since 3Dmol.js doesn't directly support SMILES, we'll use a workaround
    // In a real application, you'd convert SMILES to SDF/MOL format first
    // For now, we'll show a placeholder message and basic atom representation
    
    // Create a simple representation based on common molecular patterns
    let atomCount = (smiles.match(/[A-Z]/g) || []).length;
    let bondCount = (smiles.match(/[-=#]/g) || []).length;
    
    // Add some basic atoms in a simple arrangement
    const atoms = [];
    for (let i = 0; i < Math.min(atomCount, 10); i++) {
      atoms.push({
        elem: ['C', 'O', 'N', 'S', 'P'][i % 5],
        x: Math.cos(i * 0.6) * 2,
        y: Math.sin(i * 0.6) * 2,
        z: (i % 3 - 1) * 0.5
      });
    }
    
    // Add atoms to viewer
    atoms.forEach(atom => {
      viewer.addSphere({
        center: {x: atom.x, y: atom.y, z: atom.z},
        radius: 0.5,
        color: atom.elem === 'C' ? 'gray' : 
               atom.elem === 'O' ? 'red' :
               atom.elem === 'N' ? 'blue' :
               atom.elem === 'S' ? 'yellow' : 'orange'
      });
    });
    
    // Add some bonds
    for (let i = 0; i < atoms.length - 1; i++) {
      if (Math.random() > 0.3) { // Random bonds for demo
        viewer.addCylinder({
          start: {x: atoms[i].x, y: atoms[i].y, z: atoms[i].z},
          end: {x: atoms[i+1].x, y: atoms[i+1].y, z: atoms[i+1].z},
          radius: 0.1,
          color: 'gray'
        });
      }
    }
    
    viewer.zoomTo();
    viewer.render();
    
  } catch (error) {
    console.error('Error rendering molecule:', error);
    // Show error message in viewer
    viewer.clear();
    viewer.addLabel(smiles, {
      position: {x: 0, y: 0, z: 0},
      backgroundColor: 'black',
      fontColor: 'white',
      fontSize: 12
    });
    viewer.render();
  }
}

// Control functions for molecule viewers
function resetNewDrugView() {
  if (newDrugViewer) {
    newDrugViewer.zoomTo();
    newDrugViewer.render();
  }
}

function resetKnownMedView() {
  if (knownMedViewer) {
    knownMedViewer.zoomTo();
    knownMedViewer.render();
  }
}

function toggleNewDrugStyle() {
  newDrugStyle = newDrugStyle === 'stick' ? 'sphere' : 'stick';
  // Re-render with new style (would need to be implemented)
  resetNewDrugView();
}

function toggleKnownMedStyle() {
  knownMedStyle = knownMedStyle === 'stick' ? 'sphere' : 'stick';
  // Re-render with new style (would need to be implemented)
  resetKnownMedView();
}

// Utility functions
function formatSideEffects(text) {
  if (!text) return '-';
  return '<ul class="list-disc list-inside">' +
    text.split(';').map(s => `<li>${s.trim()}</li>`).join('') +
    '</ul>';
}

// Dosage calculation functions
const concInput = document.getElementById("concentration");
const mgInput = document.getElementById("dosageMg");
const mlInput = document.getElementById("dosageMl");

function updateFromMg() {
  const conc = parseFloat(concInput.value);
  const mg = parseFloat(mgInput.value);
  if (!isNaN(conc) && conc > 0 && !isNaN(mg)) {
    mlInput.value = (mg / conc).toFixed(2);
  }
}

function updateFromMl() {
  const conc = parseFloat(concInput.value);
  const ml = parseFloat(mlInput.value);
  if (!isNaN(conc) && conc > 0 && !isNaN(ml)) {
    mgInput.value = (ml * conc).toFixed(2);
  }
}

mgInput.addEventListener("input", updateFromMg);
mlInput.addEventListener("input", updateFromMl);
concInput.addEventListener("input", () => {
  if (mgInput.value) updateFromMg();
  else if (mlInput.value) updateFromMl();
});

// Image mapping for medicine images
const imageMap = {
  "Paracetamol": "Paracetamol.png",
  "Panadol": "Panadol.png",
  "Panadol Extend": "Panadol_Extend.png",
  "Ibuprofen": "Ibuprofen.png",
  "Clarinase": "Clarinase.png",
  "Cetirizine": "Cetirizine.png",
  "Diphenhydramine": "Diphenhydramine.png",
  "Aspirin": "Aspirin.png",
  "Naproxen": "Naproxen.png",
  "Dextromethorphan_Guaifenesin": "Dextromethorphan_Guaifenesin.png",
  "Pseudoephedrine": "Pseudoephedrine.png",
  "Loratadine": "Loratadine.png",
  "Mefenamic_Acid": "Mefenamic_Acid.png",
  "5-FU + Leucovorin": "5FU_Leucovorin.png",
  "FOLFOX (Oxaliplatin + 5-FU + Leucovorin)": "FOLFOX.png",
  "FOLFIRI (Irinotecan + 5-FU + Leucovorin)": "FOLFIRI.png",
  "Gemcitabine": "Gemcitabine.png",
  "Paclitaxel": "Paclitaxel.png",
  "Doxorubicin": "Doxorubicin.png",
  "Cyclophosphamide": "Cyclophosphamide.png",
  "Methotrexate": "Methotrexate.png",
  "Cisplatin": "Cisplatin.png",
  "Carboplatin": "Carboplatin.png",
  "Imatinib": "Imatinib.png",
  "Trastuzumab": "Trastuzumab.png",
  "Bevacizumab": "Bevacizumab.png",
  "Nivolumab": "Nivolumab.png",
  "Pembrolizumab": "Pembrolizumab.png",
  "Generic": "Generic.png"
};

function imagePathFor(medName) {
  if (!medName) return "/static/images/Generic.png";
  if (imageMap[medName]) return `/static/images/${imageMap[medName]}`;
  const underscoreName = medName.replace(/\s+/g, "_");
  return `/static/images/${underscoreName}.png`;
}

// Form handling
const form = document.getElementById('predictForm');
const outputPanel = document.getElementById('outputPanel');
const runMessage = document.getElementById('runMessage');
const effectivenessEl = document.getElementById('effectiveness');
const sideEffectEl = document.getElementById('sideEffect');
const successRateEl = document.getElementById('successRate');
const specificSideEffectsEl = document.getElementById('specificSideEffects');
const matchesList = document.getElementById('matchesList');
const matchMessage = document.getElementById('matchMessage');
const matchedImageArea = document.getElementById('matchedImageArea');
const matchedName = document.getElementById('matchedName');
const comparisonTableBody = document.getElementById('comparisonTableBody');
const badge = document.getElementById('badge');
const clearBtn = document.getElementById('clearBtn');
const moleculeSection = document.getElementById('moleculeSection');

// Clear form function
clearBtn.addEventListener('click', () => {
    form.reset();
    outputPanel.style.display = 'none';
    moleculeSection.style.display = 'none';
    runMessage.textContent = '';
    matchesList.innerHTML = '';
    matchMessage.textContent = '';
    matchedImageArea.innerHTML = '';
    matchedName.textContent = '';
    comparisonTableBody.innerHTML = '';
    if (radarChartInstance) { radarChartInstance.destroy(); radarChartInstance = null; }
    if (ethnicityChartInstance) { ethnicityChartInstance.destroy(); ethnicityChartInstance = null; }
    if (rollerChartInstance) { rollerChartInstance.destroy(); rollerChartInstance = null; }
    if (newDrugViewer) { newDrugViewer.clear(); }
    if (knownMedViewer) { knownMedViewer.clear(); }
});

// Auto-set Line of Treatment based on disease
const targetSymptomEl = document.getElementById('targetSymptom');
const lineOfTreatmentEl = document.getElementById('lineOfTreatment');

const autoTreatmentMap = {
  "Breast Cancer (HER2+)": "Targeted",
  "Breast Cancer": "First-Line",
  "Colon Cancer": "First-Line",
  "Lung Cancer": "First-Line",
  "Leukemia": "Targeted",
  "Lymphoma": "First-Line",
  "Pancreatic Cancer": "Second-Line",
  "Melanoma": "Targeted",
  "Fever": "General",
  "Cough": "General",
  "Headache": "General",
  "Flu": "General",
  "Sore Throat": "General"
};

targetSymptomEl.addEventListener('change', () => {
  const selected = targetSymptomEl.value;
  if (autoTreatmentMap[selected]) {
    lineOfTreatmentEl.value = autoTreatmentMap[selected];
  } else {
    lineOfTreatmentEl.value = "General";
  }
});

// Simulation curve generation
function generateSimulationCurve(drug) {
  const months = [0, 1, 2, 3, 4, 5, 6];
  const values = [];
  const successRate = Number(drug.success_rate) || 0;
  const effectiveness = Number(drug.effectiveness) || 0;
  const risk = (drug.side_effect_risk || "").toLowerCase();

  months.forEach(m => {
    let heal = successRate * (1 - Math.exp(-(effectiveness / 100) * m));
    if (risk === "medium" && m === 3) heal -= 5;
    if (risk === "high" && (m === 2 || m === 5)) heal -= 10;
    values.push(Math.max(0, Math.min(100, Math.round(heal))));
  });

  return { months, values };
}

function addWiggle(values, magnitude=3) {
  return values.map(v => {
    const delta = (Math.random() * 2 - 1) * magnitude;
    return Math.max(0, Math.min(100, Math.round(v + delta)));
  });
}

// Initialize viewers when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Wait for 3Dmol to load before initializing
  setTimeout(initializeMoleculeViewers, 1000);
});

// Main form submission handler
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  runMessage.textContent = 'Sending to server...';
  outputPanel.style.display = 'none';
  moleculeSection.style.display = 'none';
  matchesList.innerHTML = '';
  matchMessage.textContent = '';
  matchedImageArea.innerHTML = '';
  matchedName.textContent = '';
  comparisonTableBody.innerHTML = '';
  
  // Clear existing charts and viewers
  if (radarChartInstance) { radarChartInstance.destroy(); radarChartInstance = null; }
  if (ethnicityChartInstance) { ethnicityChartInstance.destroy(); ethnicityChartInstance = null; }
  if (rollerChartInstance) { rollerChartInstance.destroy(); rollerChartInstance = null; }
  if (newDrugViewer) { newDrugViewer.clear(); }
  if (knownMedViewer) { knownMedViewer.clear(); }

  // Collect form data
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  // Handle health conditions
  const selectedCondition = formData.get("health_condition");
  data.health_conditions = selectedCondition && selectedCondition !== "none" 
      ? [selectedCondition] 
      : [];

  try {
    // Mock API call since we don't have the actual backend
    // In real implementation, this would be: const res = await fetch('/predict', {...})
    const mockResponse = {
      predicted_effectiveness: 75,
      predicted_side_effect_risk: "Medium",
      predicted_specific_side_effects: "Nausea;Dizziness;Headache",
      predicted_success_rate: 78,
      new_drug_note: "Effectiveness adjusted due to health conditions",
      new_drug_explanations: ["Adjusted for selected health condition"],
      explanations: {
        effectiveness: "Effectiveness remains stable",
        side_effects: "Moderate predicted side effect risk",
        success_rate: "Success rate remains stable"
      },
      top_matches: [
        {
          medicine_name: "Paracetamol",
          target_symptom: "Fever",
          line_of_treatment: "general",
          dosage_mg: 500,
          percent: 85.5,
          ingredients_active: ["Paracetamol"],
          ingredients_inactive: [],
          effectiveness: 80,
          success_rate: 85,
          side_effect_risk: "Low",
          known_side_effects: "Nausea;Dizziness",
          risky: false,
          risk_reasons: []
        }
      ],
      best_match: {
        medicine_name: "Paracetamol",
        target_symptom: "Fever",
        line_of_treatment: "general",
        dosage_mg: 500,
        percent: 85.5,
        ingredients_active: ["Paracetamol"],
        ingredients_inactive: [],
        effectiveness: 80,
        success_rate: 85,
        side_effect_risk: "Low",
        known_side_effects: "Nausea;Dizziness",
        risky: false
      },
      strong_match: true,
      ethnicity_scores: {
        new_drug: { "Malay": 75, "Chinese": 77, "Indian": 73, "Indigenous": 76 },
        known_medicine: { "Malay": 80, "Chinese": 82, "Indian": 78, "Indigenous": 81 }
      }
    };

    const result = mockResponse;
    runMessage.textContent = '';
    outputPanel.style.display = 'block';

    // Display basic results
    effectivenessEl.textContent = (result.predicted_effectiveness ?? '-') + '%';
    sideEffectEl.textContent = result.predicted_side_effect_risk ?? '-';
    successRateEl.textContent = (result.predicted_success_rate ?? '-') + '%';

    // Show explanations
    const reasonsBox = document.getElementById("newDrugReasons");
    reasonsBox.innerHTML = "";

    if (result.new_drug_note) {
      const warn = document.createElement("div");
      warn.className = "bg-red-100 text-red-800 rounded px-2 py-1 text-sm";
      warn.textContent = result.new_drug_note;
      reasonsBox.appendChild(warn);
    }

    if (result.new_drug_explanations) {
      result.new_drug_explanations.forEach(msg => {
        if (msg && msg.trim() !== "") {
          const div = document.createElement("div");
          div.textContent = "â€¢ " + msg;
          reasonsBox.appendChild(div);
        }
      });
    }

    if (result.explanations) {
      const exp = result.explanations;
      const html = `
        <p><b>Effectiveness:</b> ${exp.effectiveness || '-'}</p>
        <p><b>Side Effects:</b> ${exp.side_effects || '-'}</p>
        <p><b>Success Rate:</b> ${exp.success_rate || '-'}</p>
      `;
      reasonsBox.innerHTML += html;
    }

    // Show best match
    const matchBox = document.getElementById("bestMatchBox");
    if (matchBox) {
      matchBox.innerHTML = `
        <h3 class="text-lg font-semibold mb-1">Best Match</h3>
        <p><b>Medicine:</b> ${result.best_match?.medicine_name || "No match found"}</p>
        <p><b>Similarity Score:</b> ${result.best_match?.percent ?? 0}%</p>
      `;
    }

    if (result.strong_match && result.best_match) {
      badge.textContent = `Strong match: ${result.best_match.medicine_name} (${result.best_match.percent}%)`;
      matchMessage.textContent = `Best match: ${result.best_match.medicine_name} â€” ${result.best_match.percent}% similarity.`;
    } else {
      badge.textContent = 'No strong match';
      matchMessage.textContent = result.message || 'No strong match found.';
    }

    specificSideEffectsEl.textContent = result.predicted_specific_side_effects ?? '-';

    // Show top matches
    (result.top_matches || []).forEach(m => {
      const card = document.createElement('div');
      card.innerHTML = `
        <div class="text-sm font-semibold">
          ${m.medicine_name} <span class="text-xs text-gray-500">(${m.target_symptom})</span>
        </div>
        <div class="text-xs text-gray-600">Match: <strong>${m.percent}%</strong></div>
        <div class="text-xs text-gray-600"><strong>Active:</strong> ${(m.ingredients_active || []).join(', ') || '-'}</div>
        <div class="text-xs text-gray-600"><strong>Known side effects:</strong> ${formatSideEffects(m.known_side_effects)}</div>
      `;
      matchesList.appendChild(card);
    });

    // Display matched image
    const best = result.best_match || (result.top_matches && result.top_matches[0]);
    if (best) {
      const img = document.createElement('img');
      img.alt = best.medicine_name;
      img.src = imagePathFor(best.medicine_name);
      img.onerror = () => img.src = '/static/images/Generic.png';
      matchedImageArea.appendChild(img);
      matchedName.textContent = best.medicine_name;

      // Show molecular structure comparison
      moleculeSection.style.display = 'block';
      
      // Get SMILES for new drug and known medicine
      const newDrugSmiles = data.smiles || smilesDatabase[data.drug_name] || "CC(=O)NC1=CC=C(O)C=C1"; // Default to paracetamol
      const knownMedSmiles = smilesDatabase[best.medicine_name] || "CC(=O)NC1=CC=C(O)C=C1";

      // Update SMILES displays
      document.getElementById('newDrugSmiles').textContent = newDrugSmiles;
      document.getElementById('knownMedSmiles').textContent = knownMedSmiles;
      document.getElementById('knownMedTitle').textContent = best.medicine_name;

      // Render molecules
      setTimeout(() => {
        renderMolecule(newDrugViewer, newDrugSmiles, data.drug_name);
        renderMolecule(knownMedViewer, knownMedSmiles, best.medicine_name);
      }, 500);

      // Create comparison table
      const newDrug = {
        drug_name: data.drug_name,
        ingredients: data.ingredients,
        dosage_mg: data.dosage_mg || data.dosageMg || '-',
        line_of_treatment: data.line_of_treatment || data.lineOfTreatment || '-',
        target_symptom: data.target_symptom,
        health_condition: data.health_conditions || [],
        effectiveness: result.predicted_effectiveness,
        success_rate: result.predicted_success_rate,
        side_effect_risk: result.predicted_side_effect_risk,
        predicted_specific_side_effects: result.predicted_specific_side_effects || [],
        smiles: newDrugSmiles
      };

      comparisonTableBody.innerHTML = '';

      const rows = [
        ['Drug Name', newDrug.drug_name || '-', best.medicine_name || '-'],
        ['SMILES Structure', newDrugSmiles, knownMedSmiles],
        ['Target Symptom', newDrug.target_symptom || '-', best.target_symptom || '-'],
        ['Line of Treatment', newDrug.line_of_treatment || '-', best.line_of_treatment || '-'],
        ['Health Condition', (newDrug.health_condition || []).join(', ') || '-', best.health_condition || '-'],
        ['Ingredients', newDrug.ingredients || '-', (best.ingredients_active || []).join(', ') || '-'],
        ['Dosage (mg)', newDrug.dosage_mg || '-', best.dosage_mg || '-'],
        ['Effectiveness', `${newDrug.effectiveness}%`, best.effectiveness ? best.effectiveness + '%' : '-'],
        ['Success Rate', `${newDrug.success_rate}%`, best.success_rate ? best.success_rate + '%' : '-'],
        ['Side Effect Risk', newDrug.side_effect_risk || '-', best.side_effect_risk || '-']
      ];

      rows.forEach(([label, a, b]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 font-semibold">${label}</td>
          <td class="px-3 py-2" style="word-break: break-all;">${a}</td>
          <td class="px-3 py-2" style="word-break: break-all;">${b}</td>
        `;
        comparisonTableBody.appendChild(tr);
      });

      // Create radar chart
      const safetyMap = { 'Low': 100, 'Medium': 50, 'High': 10 };
      const ndEffect = Number(newDrug.effectiveness) || 0;
      const ndSuccess = Number(newDrug.success_rate) || 0;
      const ndSafety = safetyMap[newDrug.side_effect_risk] ?? 0;
      const ndDosageScaled = Math.min(100, Number(newDrug.dosage_mg) || 0) / 10;
      const ndIngCount = (newDrug.ingredients || '').split(';').filter(x => x.trim()).length * 10;

      const knEffect = Number(best.effectiveness) || 0;
      const knSuccess = Number(best.success_rate) || 0;
      const knSafety = safetyMap[best.side_effect_risk] ?? 0;
      const knDosageScaled = Math.min(100, Number(best.dosage_mg) || 0) / 10;
      const knIngCount = (best.ingredients_active || []).length * 10;

      const ctx = document.getElementById('radarChart').getContext('2d');
      radarChartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Effectiveness', 'Success', 'Safety', 'Dosage', '#Ingredients'],
          datasets: [
            {
              label: 'New Drug',
              data: [ndEffect, ndSuccess, ndSafety, ndDosageScaled, ndIngCount],
              backgroundColor: 'rgba(79,70,229,0.2)',
              borderColor: '#4f46e5',
              pointBackgroundColor: '#4f46e5',
              fill: true,
              borderWidth: 2
            },
            {
              label: 'Known Medicine',
              data: [knEffect, knSuccess, knSafety, knDosageScaled, knIngCount],
              backgroundColor: 'rgba(16,185,129,0.2)',
              borderColor: '#10b981',
              pointBackgroundColor: '#10b981',
              fill: true,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top', labels: { color: 'white' } } },
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 100,
              ticks: { stepSize: 20, color: '#6b7280', backdropColor: 'transparent' },
              angleLines: { color: '#d1d5db' },
              grid: { color: '#e5e7eb' },
              pointLabels: { color: 'white', font: { size: 12 } }
            }
          }
        }
      });

      // Create ethnicity radar chart
      const ctx2 = document.getElementById('ethnicityRadarChart').getContext('2d');
      const labels = ["Malay", "Chinese", "Indian", "Indigenous"];
      const newDrugData = labels.map(l => result.ethnicity_scores?.new_drug?.[l] ?? 0);
      const knownMedData = labels.map(l => result.ethnicity_scores?.known_medicine?.[l] ?? 0);
      const selectedEthnicity = data.race || '';

      ethnicityChartInstance = new Chart(ctx2, {
          type: 'radar',
          data: {
              labels: labels,
              datasets: [
                  {
                      label: "New Drug",
                      data: newDrugData,
                      borderColor: "#4f46e5",
                      backgroundColor: "rgba(79,70,229,0.2)",
                      pointBackgroundColor: newDrugData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#4f46e5'
                      ),
                      pointBorderColor: newDrugData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#4f46e5'
                      )
                  },
                  {
                      label: "Known Medicine",
                      data: knownMedData,
                      borderColor: "#10b981",
                      backgroundColor: "rgba(16,185,129,0.2)",
                      pointBackgroundColor: knownMedData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#10b981'
                      ),
                      pointBorderColor: knownMedData.map((_, i) =>
                          labels[i] === selectedEthnicity ? 'yellow' : '#10b981'
                      )
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { labels: { color: 'white' } },
                  title: { display: true, text: 'Drug Performance by Ethnicity', color: 'white' }
              },
              scales: {
                  r: {
                      suggestedMin: 0,
                      suggestedMax: 100,
                      ticks: { stepSize: 20, color: 'white' },
                      angleLines: { color: 'rgba(255,255,255,0.2)' },
                      grid: { color: 'rgba(255,255,255,0.1)' },
                      pointLabels: { color: 'white', font: { size: 12 } }
                  }
              }
          }
      });

      // Create recovery simulation chart
      const ndCurve = generateSimulationCurve(newDrug);
      const bmCurve = generateSimulationCurve(best);
      ndCurve.values = addWiggle(ndCurve.values, 3);
      bmCurve.values = addWiggle(bmCurve.values, 3);

      const ctxRoller = document.getElementById('rollerChart').getContext('2d');
      rollerChartInstance = new Chart(ctxRoller, {
        type: 'line',
        data: {
          labels: ndCurve.months.map(m => `Month ${m}`),
          datasets: [
            {
              label: newDrug.drug_name || "New Drug",
              data: ndCurve.values,
              borderColor: "rgba(75,192,192,1)",
              backgroundColor: "rgba(75,192,192,0.3)",
              tension: 0.4,
              fill: true
            },
            {
              label: best.medicine_name || "Best Match",
              data: bmCurve.values,
              borderColor: "rgba(255,99,132,1)",
              backgroundColor: "rgba(255,99,132,0.3)",
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: "Predicted Patient Healing Over 6 Months",
              color: 'white',
              font: { size: 16 }
            },
            legend: { labels: { color: 'white' } }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: 'Patient Cure/Healing (%)', color: 'white' },
              ticks: { color: 'white' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            x: {
              title: { display: true, text: 'Months', color: 'white' },
              ticks: { color: 'white' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
    }

  } catch (err) {
    console.error(err);
    runMessage.textContent = 'Server Error: ' + err.message;
  }
});

// PDF Download functionality
document.getElementById('downloadPDF').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const section = document.getElementById('outputPanel');
  const btn = document.getElementById('downloadPDF');
  btn.style.display = 'none';
  
  try {
    const canvas = await html2canvas(section, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 10;
    
    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
    heightLeft -= pageHeight - 20;
    
    while (heightLeft > 0) {
      position = heightLeft - imgHeight + 10;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight - 20;
    }
    
    pdf.save(`pharmasim_result_${Date.now()}.pdf`);
  } catch (error) {
    console.error('PDF generation error:', error);
    alert('Error generating PDF. Please try again.');
  }
  
  btn.style.display = 'block';
});
</script>
</body>
</html>